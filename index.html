<!DOCTYPE 5>
<html><head><meta charset="utf-8"><title>Spiritcase Sprite Editor</title><style type="text/css">input, button { margin-top: 0; margin-bottom:0; }
body { border:0;margin:0;padding:0; }
#spiritcaseContainer {
  background: #222;
  text-align: center;
  font-size: 22px;
  font-family: 'Helvetica', 'Times', serif;
  text-shadow: 0 1px 1px blue;
}
.banner {
  border: 5px solid white;
  border: 5px solid white rgba(255,255,255,0.9);
  box-shadow: 0 2px 4px blue;
  margin: 1em;
}
#spiritcaseContainer p {
  color:white;
  color:rgba(255,255,255,0.9);
  margin-top:0.418em;
  margin-bottom:0.418em;
  margin-left:auto;
  margin-right:auto;
  width:22em;
  max-width:100%;
}
#spiritcaseContainer a {
  /*
  color:rgb(200,255,255);
  color:rgba(200,255,255,0.9);
  */
  color:white;
  color:rgba(255,255,255,0.9);
  text-decoration:none;
  display: inline-block;
  border: 1px solid white;
  padding: 0 0.2em;
  border-radius: 0.2em;
  -moz-border-radius: 0.2em;
  -webkit-border-radius: 0.2em;
  -ie-border-radius: 0.2em;
}
#spiritcaseContainer a:hover {
  background-color:rgba(20,70,180,1.0);
}
.page {
  width: 100%;
  height: 100%;
  margin: 0;
  border: 0;
}
.centering {
  display: table;
  padding: 0;
}
.centered {
  display: table-cell;
  vertical-align: middle;
  text-align: center;
}
.inline-block {
  display: inline-block;
}
.dynamic-section {
  display: inline-block;
  vertical-align:middle;
  max-width:100%;
}
.dynamic-section.dynsec-vertical {
  display: block;
}
.flip-lr {
  -moz-transform:     scaleX(-1);
  -o-transform:       scaleX(-1);
  -webkit-transform:  scaleX(-1);
  transform:          scaleX(-1);
  filter:             FlipH;
  -ms-filter:         "FlipH";
}
.pixelart {
  image-rendering:optimizeSpeed;             /* Legal fallback */
  image-rendering:-moz-crisp-edges;          /* Firefox        */
  image-rendering:-o-crisp-edges;            /* Opera          */
  image-rendering:-webkit-optimize-contrast; /* Safari         */
  image-rendering:optimize-contrast;         /* CSS3 Proposed  */
  image-rendering:crisp-edges;               /* CSS4 Proposed  */
  image-rendering:pixelated;                 /* CSS4 Proposed  */
  -ms-interpolation-mode:nearest-neighbor;   /* IE8+           */
}
.coffeecharniaContainer {
  opacity: 0.2;
}
.coffeecharniaContainer:hover {
  opacity: 0.8;
}
.spiritcaseDialog {
  padding-top:1em;
}
.sliderInputValue {
    font-size:100%;
    font-weight:bold;
    color:white;
    font-family: sans;
    text-shadow: 0 0 1px black, 0 0 2px black, 0 0 2px black;
}
.sliderInputLabel {
    font-size:75%;
    font-weight:bold;
    color:white;
    font-family: sans;
    text-shadow: 0 0 1px black, 0 0 2px black, 0 0 2px black;
}
.sliderInputButton {
    font-size:150%;
    font-weight:bold;
    color:white;
    font-family: sans;
    text-align:center;
    cursor:pointer;
}
.sliderInputButton:hover {
    background:rgba(0,0,0,0.2);
}
.sliderInputButton:not(:hover) {
    opacity:0.6;
    cursor: cross;
}
.framesList {
  cursor:pointer;
}
.framesList canvas, .undoHistory canvas {
  margin:2px;
  padding:1px;
  border:1px solid black;
}
.framesList canvas:hover, .undoHistory canvas:hover {
  border:1px solid white;
}</style></head><body style="width:100%;height:100%;overflow:hidden"><div id="spiritcaseContainer" class="centering page"><section class="centered"><section class="dynamic-section dynsec-vertical"><span style="border-color:#000;border-width:1px;border-style:solid;padding:1px;display:inline-table"><canvas id="icon" width="30" height="22"></canvas></span></section><section class="dynamic-section dynsec-vertical"><canvas id="canvas" width="481" height="353"></canvas></section></section></div><script type="text/javascript">window.spiritcase={"factor":16,"factorX":16,"factorY":16,"sizeX":30,"sizeY":22,"gridSize":1,"checkersSize":8,"borderColor":"#000","icon":{"borderColor":"#000","borderWidth":"1","padding":"1"}};</script><script type="text/javascript">/^u/.test(typeof define)&&function(a){var b=this.require=function(b){return a[b]};this.define=function(c,d){a[c]=a[c]||d(b)}}({}),define("minified",function(){function a(a){return a!=z?""+a:""}function b(a){return/^str/.test(typeof a)}function c(a){return a&&a.nodeType}function d(a){return a}function e(a,b){j(a,function(a){a(b)})}function f(a,b){for(var c in a)b(c,a[c])}function g(a,b){var c=[];return j(a,function(d,e){b.call(a,d,e)&&c.push(d)}),c}function h(a,b,c){var d=[];return a(b,function(a,e){j(c.call(b,a,e),function(a){d.push(a)})}),d}function i(b,c,d){return a(b).replace(c,d||"")}function j(a,b){if(l(a))for(var c=0;c<a.length;c++)b.call(a,a[c],c);else a!=z&&b(a,0);return a}function k(a){return"function"==typeof a&&!a.item}function l(a){return a&&a.length!=z&&!b(a)&&!c(a)&&!k(a)&&a!==A}function m(a){return parseFloat(i(a,/^[^\d-]+/))}function n(a){return a.Nia=a.Nia||++D}function o(a,b){var c,d=[],e={};return j(a,function(a){j(b(a),function(a){e[c=n(a)]||(d.push(a),e[c]=!0)})}),d}function p(a,b){var c={$position:"absolute",$visibility:"hidden",$display:"block",$height:z},d=a.get(c),c=a.set(c).get("clientHeight");return a.set(d),c*b+"px"}function q(a){E?E.push(a):setTimeout(a,0)}function r(a){return h(j,a,function(a){return l(a)?r(a):(c(a)&&(a=a.cloneNode(!0),a.removeAttribute&&a.removeAttribute("id")),a)})}function s(a,b,c){return k(a)?q(a):new x(t(a,b,c))}function t(a,d,e){function f(a){return l(a)?h(j,a,f):a}function i(a){return g(h(j,a,f),function(a){for(;a=a.parentNode;)if(a==d[0]||e)return a==d[0]})}return d?1!=(d=t(d)).length?o(d,function(b){return t(a,b,e)}):b(a)?1!=c(d[0])?[]:e?i(d[0].querySelectorAll(a)):d[0].querySelectorAll(a):i(a):b(a)?document.querySelectorAll(a):h(j,a,f)}function u(a,d){function e(a,b){var c=RegExp("(^|\\s+)"+a+"(?=$|\\s)","i");return function(d){return a?c.test(d[b]):!0}}var f,g,h={},i=h;return k(a)?a:/^num/.test(typeof a)?function(b,c){return c==a}:!a||"*"==a||b(a)&&(i=/^([\w-]*)\.?([\w-]*)$/.exec(a))?(f=e(i[1],"tagName"),g=e(i[2],"className"),function(a){return 1==c(a)&&f(a)&&g(a)}):d?function(b){return s(a,d).find(b)!=z}:(s(a).each(function(a){h[n(a)]=!0}),function(a){return h[n(a)]})}function v(a){var b=u(a);return function(a){return b(a)?z:!0}}function w(){function a(a,f){b==z&&(b=a,c=f,setTimeout(function(){e(d)},0))}var b,c,d=[],f=a.then=function(a,e){function f(){var d,f;try{d=b?a:e,k(d)?(f=d.apply(y,c),f&&f.then?f.then(function(a){g(!0,[a])},function(a){g(!1,[a])}):g(!0,[f])):g(b,c)}catch(h){g(!1,[h])}}var g=w();return b==z?d.push(f):setTimeout(f,0),g};return a.error=function(a){return f(0,a)},a}function x(a){for(var b=this.length=a.length,c=0;b>c;c++)this[c]=a[c]}var y,z=null,A=this,B={},C={},D=1,E=/^[ic]/.test(document.readyState)?z:[],F={},G=0;return f({each:function(a){return j(this,a)},filter:function(a){return new x(g(this,a))},collect:function(a){return new x(h(j,this,a))},sub:function(a,b){var c=0>a?this.length+a:a,d=b>=0?b:this.length+(b||0);return new x(g(this,function(a,b){return b>=c&&d>b}))},find:function(a,b){for(var c,d=k(a)?a:function(b,c){return a===b?c:void 0},e=b||0;e<this.length;e++)if((c=d.call(this,this[e],e))!=z)return c},remove:function(){j(this,function(a){a.parentNode.removeChild(a)})},text:function(){return h(j,this,function(a){return a.textContent}).join("")},trav:function(a,b,c){var d=/^num/.test(typeof b),e=u(d?z:b),f=d?b:c;return new x(o(this,function(b){for(var c=[];(b=b[a])&&c.length!=f;)e(b)&&c.push(b);return c}))},next:function(a,b){return this.trav("nextSibling",a,b||1)},up:function(a,b){return this.trav("parentNode",a,b||1)},select:function(a,b){return s(a,this,b)},is:function(a){return!this.find(v(a))},only:function(a){return new x(g(this,u(a)))},not:function(a){return new x(g(this,v(a)))},get:function(a,c){var d,e,g,h=this,k=h[0];return k?b(a)?(d=/^(\W*)(.*)/.exec(i(a,/^%/,"@data-")),e=d[1],k=C[e]?C[e](this,d[2]):"$"==a?h.get("className"):"$$"==a?h.get("@style"):"$$slide"==a?h.get("$height"):"$$fade"==a||"$$show"==a?"hidden"==h.get("$visibility")||"none"==h.get("$display")?0:"$$fade"==a?isNaN(h.get("$opacity",!0))?1:h.get("$opacity",!0):1:"$"==e?A.getComputedStyle(k,z).getPropertyValue(i(d[2],/[A-Z]/g,function(a){return"-"+a.toLowerCase()})):"@"==e?k.getAttribute(d[2]):k[d[2]],c?m(k):k):(g={},(l(a)?j:f)(a,function(a){g[a]=h.get(a,c)}),g):void 0},set:function(a,c){var d,e,g=this;return c!==y?(d=/^(\W*)(.*)/.exec(i(i(a,/^\$float$/,"cssFloat"),/^%/,"@data-")),e=d[1],B[e]?B[e](this,d[2],c):"$$fade"==a?this.set({$visibility:c?"visible":"hidden",$opacity:c}):"$$slide"==a?g.set({$visibility:c?"visible":"hidden",$overflow:"hidden",$height:/px/.test(c)?c:function(a,b,d){return p(s(d),c)}}):"$$show"==a?c?g.set({$visibility:c?"visible":"hidden",$display:""}).set({$display:function(a){return"none"==a?"block":a}}):g.set({$display:"none"}):"$$"==a?g.set("@style",c):j(this,function(b,f){var g=k(c)?c(s(b).get(a),f,b):c;"$"==e?d[2]?b.style[d[2]]=g:j(g&&g.split(/\s+/),function(a){var c=i(a,/^[+-]/),d=b.className||"",e=i(d,RegExp("(^|\\s+)"+c+"(?=$|\\s)"));(/^\+/.test(a)||c==a&&d==e)&&(e+=" "+c),b.className=i(e,/^\s+/g)}):"$$scrollX"==a?b.scroll(g,s(b).get("$$scrollY")):"$$scrollY"==a?b.scroll(s(b).get("$$scrollX"),g):"@"==e?g==z?b.removeAttribute(d[2]):b.setAttribute(d[2],g):b[d[2]]=g})):b(a)||k(a)?g.set("$",a):f(a,function(a,b){g.set(a,b)}),g},show:function(){return this.set("$$show",1)},hide:function(){return this.set("$$show",0)},add:function(a,b){return this.each(function(d,e){function f(a){l(a)?j(a,f):k(a)?f(a(d,e)):a!=z&&(a=c(a)?a:document.createTextNode(a),g?g.parentNode.insertBefore(a,g.nextSibling):b?b(a,d,d.parentNode):d.appendChild(a),g=a)}var g;f(e&&!k(a)?r(a):a)})},fill:function(a){return this.each(function(a){s(a.childNodes).remove()}).add(a)},addAfter:function(a){return this.add(a,function(a,b,c){c.insertBefore(a,b.nextSibling)})},addBefore:function(a){return this.add(a,function(a,b,c){c.insertBefore(a,b)})},addFront:function(a){return this.add(a,function(a,b){b.insertBefore(a,b.firstChild)})},replace:function(a){return this.add(a,function(a,b,c){c.replaceChild(a,b)})},clone:function(){return new x(r(this))},animate:function(a,b,c){var d,g=w(),i=this,l=h(j,this,function(b,d){var e,g=s(b),h={};return f(e=g.get(a),function(c,e){var f=a[c];h[c]=k(f)?f(e,d,b):"$$slide"==c?p(g,f):f}),g.dial(e,h,c)}),m=b||500;return g.stop=function(){return g(!1),d()},d=s.loop(function(a){e(l,a/m),a>=m&&(d(),g(!0,[i]))}),g},dial:function(b,c,d){function e(a,b){return/^#/.test(a)?parseInt(6<a.length?a.substr(2*b+1,2):(a=a.charAt(b+1))+a,16):m(a.split(",")[b])}var g=this,h=d||0,j=k(h)?h:function(a,b,c){return c*(b-a)*(h+(1-h)*c*(3-2*c))+a};return function(d){f(b,function(b,f){var h=c[b],k=0;g.set(b,0>=d?f:d>=1?h:/^#|rgb\(/.test(h)?"rgb("+Math.round(j(e(f,k),e(h,k++),d))+","+Math.round(j(e(f,k),e(h,k++),d))+","+Math.round(j(e(f,k),e(h,k++),d))+")":i(h,/-?[\d.]+/,a(j(m(f),m(h),d))))})}},toggle:function(a,b,c,d){var e,f,g=this,h=!1;return b?(g.set(a),function(i){i!==h&&(f=(h=!0===i||!1===i?i:!h)?b:a,c?(e=g.animate(f,e?e.stop():c,d)).then(function(){e=z}):g.set(f))}):g.toggle(i(a,/\b(?=\w)/g,"-"),i(a,/\b(?=\w)/g,"+"))},values:function(b){var c=b||{};return this.each(function(b){var e=b.name||b.id,f=a(b.value);if(/form/i.test(b.tagName))for(e=0;e<b.elements.length;e++)s(b.elements[e]).values(c);else!e||/ox|io/i.test(b.type)&&!b.checked||(c[e]=c[e]==z?f:h(j,[c[e],f],d))}),c},offset:function(){for(var a=this[0],b={x:0,y:0};a;)b.x+=a.offsetLeft,b.y+=a.offsetTop,a=a.offsetParent;return b},on:function(c,e,f,g,l){return k(e)?this.on(z,c,e,f,g):b(g)?this.on(c,e,f,z,g):this.each(function(b,k){j(c?t(c,b):b,function(b){j(a(e).split(/\s/),function(a){function c(a,c,d){var e,h=!l;if(d=l?d:b,l)for(e=u(l,b);d&&d!=b&&!(h=e(d));)d=d.parentNode;return!h||m!=a||f.apply(s(d),g||[c,k])&&"?"==n||"|"==n}function e(a){c(m,a,a.target)||(a.preventDefault(),a.stopPropagation())}var m=i(a,/[?|]/g),n=i(a,/[^?|]/g),o=("blur"==m||"focus"==m)&&!!l,p=D++;b.addEventListener(m,e,o),b.M||(b.M={}),b.M[p]=c,f.M=h(j,[f.M,function(){b.removeEventListener(m,e,o),delete b.M[p]}],d)})})})},onOver:function(a,b){var c=this,d=[];return k(b)?this.on(a,"|mouseover |mouseout",function(a,e){var f=a.relatedTarget||a.toElement,g="mouseout"!=a.type;d[e]===g||!g&&f&&(f==c[e]||s(f).up(c[e]).length)||(d[e]=g,b.call(this,g,a))}):this.onOver(z,a)},onFocus:function(a,b,c){return k(b)?this.on(a,"|blur",b,[!1],c).on(a,"|focus",b,[!0],c):this.onFocus(z,a,b)},onChange:function(a,b,c){return k(b)?this.on(a,"|input |change |click",function(a,c){var d=this[0],e=/ox|io/i.test(d.type)?d.checked:d.value;d.NiaP!=e&&b.call(this,d.NiaP=e,c)},c):this.onChange(z,a,b)},onClick:function(a,b,c,d){return k(b)?this.on(a,"click",b,c,d):this.onClick(z,a,b,c)},trigger:function(a,b){return this.each(function(c){for(var d=!0,e=c;e&&d;)f(e.M,function(e,f){d=d&&f(a,b,c)}),e=e.parentNode})}},function(a,b){x.prototype[a]=b}),f({request:function(b,c,d,e){e=e||{};var g,i=0,k=w(),l=d&&d.constructor==e.constructor;try{k.xhr=g=new XMLHttpRequest,k.stop=function(){g.abort()},l&&(d=h(f,d,function(a,b){return h(j,b,function(b){return encodeURIComponent(a)+(b!=z?"="+encodeURIComponent(b):"")})}).join("&")),d==z||/post/i.test(b)||(c+="?"+d,d=z),g.open(b,c,!0,e.user,e.pass),l&&/post/i.test(b)&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f(e.headers,function(a,b){g.setRequestHeader(a,b)}),f(e.xhr,function(a,b){g[a]=b}),g.onreadystatechange=function(){4!=g.readyState||i++||(200==g.status?k(!0,[g.responseText,g]):k(!1,[g.status,g.responseText,g]))},g.send(d)}catch(m){i||k(!1,[0,z,a(m)])}return k},toJSON:JSON.stringify,parseJSON:JSON.parse,ready:q,loop:function(a){function b(a){f(F,function(b,c){c(a)}),G&&h(b)}function c(){return F[g]&&(delete F[g],G--),e}var d,e=0,g=D++,h=A.requestAnimationFrame||function(a){setTimeout(function(){a(+new Date)},33)};return F[g]=function(b){d=d||b,a(e=b-d,c)},G++||h(b),c},off:function(a){e(a.M),a.M=z}},function(a,b){s[a]=b}),document.addEventListener("DOMContentLoaded",function(){e(E),E=z},!1),{$:s,$$:function(a,b,c){return t(a,b,c)[0]},EE:function(a,b,c){return a=s(document.createElement(a)),l(b)||!/^ob/.test(typeof b)?a.add(b):a.set(b).add(c)},M:x,getter:C,setter:B}});</script><script type="text/javascript">// Generated by CoffeeScript 1.4.0
(function() {
  var lib, list2set, version,
    __slice = [].slice;

  version = "1.2.0";

  list2set = function(l) {
    var r, x, _i, _len;
    r = {};
    for (_i = 0, _len = l.length; _i < _len; _i++) {
      x = l[_i];
      r[x] = 1;
    }
    return r;
  };

  lib = {
    libraryName: "htmlcup",
    libraryVersion: "0.2.0",
    extendObject: function(fields) {
      var n, o, v;
      o = {};
      for (n in this) {
        v = this[n];
        o[n] = v;
      }
      for (n in fields) {
        v = fields[n];
        o[n] = v;
      }
      return o;
    },
    printHtml: function(t) {
      return process.stdout.write(t);
    },
    quoteTagText: function(str) {
      return str.replace(/[&<]/g, function(c) {
        if (c === '<') {
          return '&lt;';
        } else {
          return '&amp;';
        }
      });
    },
    quoteText: function(str) {
      return str.replace(/[&<"]/g, function(c) {
        if (c === '<') {
          return '&lt;';
        } else if (c === '&') {
          return '&amp;';
        } else {
          return '&quot;';
        }
      });
    },
    docType: function(name) {
      if (name == null) {
        name = 'HTML';
      }
      return this.printHtml("<!DOCTYPE " + name + ">\n");
    },
    voidElements: list2set('area, base, br, col, command, embed, hr, img, input, keygen, link, meta, param, source, track, wbr'.split(/, */)),
    rawTextElements: list2set(['script', 'style']),
    allElements: "a, abbr, address, area, article, aside, audio, b, base, bdi, bdo,\nblockquote, body, br, button, button, button, button, canvas, caption,\ncite, code, col, colgroup, command, command, command, command,\ndatalist, dd, del, details, dfn, div, dl, dt, em, embed, fieldset,\nfigcaption, figure, footer, form, h1, h2, h3, h4, h5, h6, head,\nheader, hgroup, hr, html, i, iframe, img, input, ins, kbd, keygen,\nlabel, legend, li, link, map, mark, menu, meta, meta, meta, meta,\nmeta, meta, meter, nav, noscript, object, ol, optgroup, option,\noutput, p, param, pre, progress, q, rp, rt, ruby, s, samp, script,\nsection, select, small, source, span, strong, style, sub, summary,\nsup, table, tbody, td, textarea, tfoot, th, thead, time, title, tr,\ntrack, u, ul, var, video, wbr".match(/[a-z0-9]+/g),
    compileTag: function(tagName, isVoid, isRawText) {
      return function() {
        var arg, args, f, s, x, y, _i, _len;
        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        this.printHtml("<" + tagName);
        for (_i = 0, _len = args.length; _i < _len; _i++) {
          arg = args[_i];
          if (typeof arg === 'function') {
            f = arg;
            break;
          }
          if (typeof arg === 'string') {
            s = arg;
            break;
          }
          for (x in arg) {
            y = arg[x];
            if (y != null) {
              this.printHtml(" " + x + "=\"" + (this.quoteText(y)) + "\"");
            } else {
              this.printHtml(" " + x);
            }
          }
        }
        this.printHtml('>');
        if (isVoid) {
          return;
        }
        if (f) {
          f.apply(this);
        }
        if (s) {
          if (isRawText) {
            this.printHtml(s);
          } else {
            this.printHtml(this.quoteTagText(s));
          }
        }
        return this.printHtml('</' + tagName + '>');
      };
    },
    compileLib: function() {
      var h, x, _i, _len, _ref;
      h = {};
      _ref = this.allElements;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        x = _ref[_i];
        h[x] = this.compileTag(x, (this.voidElements[x] != null), (this.rawTextElements[x] != null));
      }
      return this.extendObject(h);
    },
    html5Page: function() {
      var args;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      this.docType(5);
      return this.html.apply(this, args);
    }
  };

  lib = lib.compileLib();

  lib = lib.extendObject({
    bareHtmlcup: lib,
    libraryVersion: version,
    cssStyle: function(x) {
      return this.style({
        type: 'text/css'
      }, x);
    },
    javaScript: function(x) {
      return this.script({
        type: "text/javascript"
      }, x.replace("</", "<\/"));
    },
    coffeeScript: function(x) {
      var codeToString, isString;
      isString = function(x) {
        return typeof x === "string" || x instanceof String;
      };
      codeToString = function(x) {
        var cs;
        if (isString(x)) {
          cs = require("coffee-script");
          return cs.compile(x);
        } else {
          return "(" + (x.toString()) + ")();\n";
        }
      };
      return this.javaScript(codeToString(x));
    },
    cssStyleSource: function(s) {
      return this.style({
        type: "text/css",
        src: s
      });
    },
    javaScriptSource: function(s) {
      return this.script({
        type: "text/javascript",
        src: s
      });
    },
    coffeeScriptSource: function(s) {
      return this.script({
        type: "text/coffeescript",
        src: s
      });
    },
    embedCoffeeScriptSource: function(f) {
      var fs;
      fs = require("fs");
      return this.coffeeScript((fs.readFileSync(f)).toString());
    },
    embedJavaScriptSource: function(f) {
      var fs;
      fs = require("fs");
      return this.javaScript((fs.readFileSync(f)).toString());
    },
    embedScriptSource: function(f) {
      var fs;
      fs = require("fs");
      if (/\.coffee$/.test(f)) {
        return this.embedCoffeeScriptSource(f);
      } else {
        return this.embedJavaScriptSource(f);
      }
    },
    embedFavicon: function(f) {
      var fs, icon;
      if (f == null) {
        f = "favicon.ico";
      }
      fs = require("fs");
      icon = fs.readFileSync(f).toString('base64');
      icon = "data:image/x-icon;base64," + icon;
      return this.link({
        rel: "shortcut icon",
        href: icon
      });
    }
  });

  (typeof exports !== "undefined" && exports !== null ? exports : window).htmlcup = lib;

}).call(this);
</script><script type="text/javascript">(function () {
        return htmlcup = htmlcup.extendObject({
          originalLib: htmlcup,
          capturedTokens: [],
          printHtml: function(t) {
            return this.capturedTokens.push(t);
          },
          captureHtml: function(f) {
            var o, p, r;
            o = this.capturedTokens;
            this.capturedTokens = [];
            f.apply(this);
            p = this.capturedTokens;
            this.capturedTokens = o;
            r = p.join("");
            this.printHtml(r);
            return r;
          },
          captureFirstTag: function(f) {
            var div;
            div = document.createElement("div");
            div.innerHTML = this.captureHtml(f);
            return div.firstChild;
          },
          stripOuter: function(x) {
            return x.replace(/^<[^>]*>/, "").replace(/<[^>]*>$/, "");
          },
          capturedParts: {},
          capturePart: function(tagName, stripOuter) {
            if (stripOuter == null) {
              stripOuter = this.stripOuter;
            }
            return function() {
              var x;
              x = arguments;
              return this.capturedParts[tagName] = stripOuter(this.captureHtml(function() {
                return this.originalLib[tagName].apply(this, x);
              }));
            };
          },
          body: function() {
            return (this.capturePart("body")).apply(this, arguments);
          },
          head: function() {
            var lib, r;
            lib = this.extendObject({
              title: function() {
                return (this.capturePart("title")).apply(this, arguments);
              },
              headStyles: [],
              style: function() {
                return this.headStyles.push((this.capturePart("style")).apply(this, arguments));
              }
            });
            r = (lib.capturePart("head")).apply(lib, arguments);
            this.capturedParts.headStyles = lib.headStyles;
            this.capturedParts.headTitle = lib.capturedParts.title;
            return r;
          },
          html5Page: function() {
            var r, x;
            x = arguments;
            this.captureHtml(function() {
              return this.originalLib.html5Page.apply(this, x);
            });
            r = this.capturedParts;
            this.capturedParts = {};
            return r;
          }
        });
      })();
</script><script type="text/javascript">(function () {
        var $, colorLib, dynmod, extendObject, extensible, sliderInput, spiritcase;
        $ = require('minified').$;
        colorLib = {
          rgb2hex: function(c) {
            return (0x1000000 + (c[0] << 16) + (c[1] << 8) + c[2]).toString(16).substring(1);
          },
          hex2rgb: function(x) {
            if (x.length === 6) {
              return [parseInt(x.substr(0, 2), 16), parseInt(x.substr(2, 2), 16), parseInt(x.substr(4, 2), 16)];
            }
            if (x.length === 3) {
              return [parseInt(x.substr(0, 1), 16) * 0x11, parseInt(x.substr(1, 1), 16) * 0x11, parseInt(x.substr(2, 1), 16) * 0x11];
            }
            throw "hex number has odd length: " + x.length;
          }
        };
        sliderInput = {
          $: $,
          terminateEvent: (function(x) {
            x.coffee = "(ev)@>\n          ev.stopPropagation()\n          ev.preventDefault()\n        ";
            return x;
          })(function(ev) {
            ev.stopPropagation();
            return ev.preventDefault();
          }),
          buttonsPressed: 0,
          mouseSet: (function(x) {
            x.coffee = "(ev,el)@>\n          r = el.getClientRects()[0]\n          sx = r.width\n          # sy = el.offsetHeight\n          x = ev.clientX - r.left\n          # y = ev.clientY - el.offsetTop\n          @barSet(x/(sx - 1), el)\n        ";
            return x;
          })(function(ev, el) {
            var r, sx, x;
            r = el.getClientRects()[0];
            sx = r.width;
            x = ev.clientX - r.left;
            return this.barSet(x / (sx - 1), el);
          }),
          barSet: (function(x) {
            x.coffee = "(bar, el)@> @setView el, { bar }";
            return x;
          })(function(bar, el) {
            return this.setView(el, {
              bar: bar
            });
          }),
          mouseDown: (function(x) {
            x.coffee = "(ev,el)@>\n          # return unless ev.target is el\n          @terminateEvent(ev)\n          # ev.target.setCapture()\n          @buttonsPressed++ if @buttonsPressed < 1\n          @mouseSet(ev,el)\n        ";
            return x;
          })(function(ev, el) {
            this.terminateEvent(ev);
            if (this.buttonsPressed < 1) {
              this.buttonsPressed++;
            }
            return this.mouseSet(ev, el);
          }),
          mouseUp: (function(x) {
            x.coffee = "(ev,el)@>\n          # return unless ev.target is el\n          @terminateEvent(ev)\n          @buttonsPressed-- if @buttonsPressed > 0\n        ";
            return x;
          })(function(ev, el) {
            this.terminateEvent(ev);
            if (this.buttonsPressed > 0) {
              return this.buttonsPressed--;
            }
          }),
          mouseMove: (function(x) {
            x.coffee = "(ev,el)@>\n          # return unless ev.target is el\n          @terminateEvent(ev)\n          @mouseSet(ev,el) if @buttonsPressed > 0\n        ";
            return x;
          })(function(ev, el) {
            this.terminateEvent(ev);
            if (this.buttonsPressed > 0) {
              return this.mouseSet(ev, el);
            }
          }),
          mouseOut: (function(x) {
            x.coffee = "(ev,el)@>\n          @terminateEvent(ev)\n          # if ev.target is el\n          # @buttonsPressed = 0\n        ";
            return x;
          })(function(ev, el) {
            return this.terminateEvent(ev);
          }),
          mouseOver: (function(x) {
            x.coffee = "(ev,el)@>\n          @terminateEvent(ev)\n          if ev.target is el\n            @buttonsPressed = 0\n        ";
            return x;
          })(function(ev, el) {
            this.terminateEvent(ev);
            if (ev.target === el) {
              return this.buttonsPressed = 0;
            }
          }),
          setView: (function(x) {
            x.coffee = "(el, {bar, text})@>\n          { $ } = @\n          el = $(el).up(\".sliderInput\")[0]\n          text?  then $(\".sliderInputValue\", el)[0].textContent = text\n          bar?   then $(\".sliderInputBar\", el).set(\"$width\", \"#{bar*100}%\")\n        ";
            return x;
          })(function(el, _arg) {
            var $, bar, text;
            bar = _arg.bar, text = _arg.text;
            $ = this.$;
            el = $(el).up(".sliderInput")[0];
            if (text != null) {
              $(".sliderInputValue", el)[0].textContent = text;
            }
            if (bar != null) {
              return $(".sliderInputBar", el).set("$width", "" + (bar * 100) + "%");
            }
          }),
          build: (function(x) {
            x.coffee = "({htmlcup, label, onclick, barColor, bgColor, buildModule, module, value, width, noBar, bar })@>\n          buildModule? then module = buildModule @\n          control = (name)-> \"javascript:#{module}.#{name}(event,this)\"\n          barColor ?= \"#888\"\n          background = if bgColor? then \"background:#{bgColor}\" else \"\"\n          value ?= \"100%\"\n          width ?= \"5em\"\n          bar ?= 0\n          mouseControls = onmousedown:control(\"mouseDown\") # , onmousemove:control(\"mouseMove\") # , onmouseup:control(\"mouseUp\"), onmouseout:control(\"mouseOut\"), onmouseover:control(\"mouseOver\")\n          htmlcup.div class:\"sliderInput\", style:\"display:inline-block;position:relative;border:1px solid #{barColor}\", ->\n              noBar or @div style:\"position:absolute;left:0;top:0;bottom:0;right:0;z-index:-1\", ->\n                  @div class:\"sliderInputBar\", style:\"position:absolute;left:0;top:0;bottom:0;width:#{bar * 100}%;background:#{barColor}\"\n              @div style:\"display:inline-table\", mouseControls, ->\n                  @div class:\"sliderInputButton\", style:\"display:table-cell;width:1.5em;font-weight:bold\", onclick:control(\"decButton\"), onmousedown:control(\"terminateEvent\"), \"-\"\n                  @div style:\"display:table-cell;width:#{width};max-width:#{width};text-align:center;overflow:visible;position:relative;background:#{bgColor}\", ->\n                      @span class:\"sliderInputLabel\", style:\"position:absolute;left:0;top:0\", ->\n                          @span label\n                      @div class:\"sliderInputValue\", style:\"position:absolute;bottom:0;right:0\", value\n                  @div class:\"sliderInputButton\", style:\"display:table-cell;width:1.5em\", onclick:control(\"incButton\"), onmousedown:control(\"terminateEvent\"), \"+\"\n  \n      ";
            return x;
          })(function(_arg) {
            var background, bar, barColor, bgColor, buildModule, control, htmlcup, label, module, mouseControls, noBar, onclick, value, width;
            htmlcup = _arg.htmlcup, label = _arg.label, onclick = _arg.onclick, barColor = _arg.barColor, bgColor = _arg.bgColor, buildModule = _arg.buildModule, module = _arg.module, value = _arg.value, width = _arg.width, noBar = _arg.noBar, bar = _arg.bar;
            if (buildModule != null) {
              module = buildModule(this);
            }
            control = function(name) {
              return "javascript:" + module + "." + name + "(event,this)";
            };
            if (barColor == null) {
              barColor = "#888";
            }
            background = bgColor != null ? "background:" + bgColor : "";
            if (value == null) {
              value = "100%";
            }
            if (width == null) {
              width = "5em";
            }
            if (bar == null) {
              bar = 0;
            }
            mouseControls = {
              onmousedown: control("mouseDown")
            };
            return htmlcup.div({
              "class": "sliderInput",
              style: "display:inline-block;position:relative;border:1px solid " + barColor
            }, function() {
              noBar || this.div({
                style: "position:absolute;left:0;top:0;bottom:0;right:0;z-index:-1"
              }, function() {
                return this.div({
                  "class": "sliderInputBar",
                  style: "position:absolute;left:0;top:0;bottom:0;width:" + (bar * 100) + "%;background:" + barColor
                });
              });
              return this.div({
                style: "display:inline-table"
              }, mouseControls, function() {
                this.div({
                  "class": "sliderInputButton",
                  style: "display:table-cell;width:1.5em;font-weight:bold",
                  onclick: control("decButton"),
                  onmousedown: control("terminateEvent")
                }, "-");
                this.div({
                  style: "display:table-cell;width:" + width + ";max-width:" + width + ";text-align:center;overflow:visible;position:relative;background:" + bgColor
                }, function() {
                  this.span({
                    "class": "sliderInputLabel",
                    style: "position:absolute;left:0;top:0"
                  }, function() {
                    return this.span(label);
                  });
                  return this.div({
                    "class": "sliderInputValue",
                    style: "position:absolute;bottom:0;right:0"
                  }, value);
                });
                return this.div({
                  "class": "sliderInputButton",
                  style: "display:table-cell;width:1.5em",
                  onclick: control("incButton"),
                  onmousedown: control("terminateEvent")
                }, "+");
              });
            });
          })
        };
        extensible = {
          extendObject: extendObject = function() {
            var k, r, v, x, _i, _len;
            r = {};
            for (k in this) {
              v = this[k];
              r[k] = v;
            }
            for (_i = 0, _len = arguments.length; _i < _len; _i++) {
              x = arguments[_i];
              for (k in x) {
                v = x[k];
                r[k] = v;
              }
            }
            return r;
          }
        };
        dynmod = extensible.extendObject({
          symCall: function(object, method, pkg) {
            if (pkg == null) {
              pkg = this;
            }
            return function() {
              return (object[method] != null ? object : pkg)[method].apply(object, arguments);
            };
          }
        });
        spiritcase = window.spiritcase;
        icon = extensible.extendObject(spiritcase.icon, {
          sizeX: spiritcase.sizeX,
          sizeY: spiritcase.sizeY,
          el: document.getElementById("icon"),
          getData: function() {
            sizeX = this.sizeX, sizeY = this.sizeY;
            return this.el.getContext("2d").getImageData(0, 0, sizeX, sizeY);
          },
          setImage: (function(x) {
            x.coffee = "(imageData)@>\n            c = @el.getContext \"2d\"\n            c.putImageData(imageData, 0, 0)    \n            @\n            unless @el.width is imageData.width and @el.height is imageData.height\n                @el.width = imageData.width\n                @el.height = imageData.height\n            c = @el.getContext \"2d\"\n            c.putImageData(imageData, 0, 0)    \n            @\n        ";
            return x;
          })(function(imageData) {
            var c;
            c = this.el.getContext("2d");
            c.putImageData(imageData, 0, 0);
            this;
            if (!(this.el.width === imageData.width && this.el.height === imageData.height)) {
              this.el.width = imageData.width;
              this.el.height = imageData.height;
            }
            c = this.el.getContext("2d");
            c.putImageData(imageData, 0, 0);
            return this;
          }),
          redraw: (function(x) {
            x.coffee = "@>\n          icon = @\n          @el.setAttribute \"style\", \"border-color:#{icon.borderColor};border-width:#{icon.borderWidth}px;border-style:solid;padding:#{icon.padding}px\"\n          @\n      ";
            return x;
          })(function() {
            var icon;
            icon = this;
            this.el.setAttribute("style", "border-color:" + icon.borderColor + ";border-width:" + icon.borderWidth + "px;border-style:solid;padding:" + icon.padding + "px");
            return this;
          })
        });
        window.spiritcase = spiritcase = extensible.extendObject(spiritcase, {
          icon: icon
        }, {
          el: document.getElementById("canvas"),
          icon: icon,
          redraw: (function(x) {
            x.coffee = "@>\n          { gridSize, factor, factorY, sizeY, factorX, sizeX, checkersSize } = @\n          canvasSizeX = factorX * sizeX + gridSize\n          canvasSizeY = factorY * sizeY + gridSize\n          @el.width = canvasSizeX if canvasSizeX isnt @el.width\n          @el.height = canvasSizeY if canvasSizeY isnt @el.height\n          iconData = @icon.getData()\n          ctx = @el.getContext \"2d\"\n          if checkersSize > 0 and checkersSize * 2 <= factor\n            x_s = sizeX * factorX\n            y_s = sizeY * factorY\n            x_i = 0\n            y_i = 0\n            y = 0\n            while y < y_s\n              x = 0\n              x_i = 0\n              while x < x_s\n                ctx.fillStyle = \"#{ [ \"181818\", \"303030\" ][ (x_i ^ y_i) & 1] }\"\n                # ctx.fillStyle = \"#f00\"\n                ctx.fillRect x, y, checkersSize, checkersSize\n                x += checkersSize\n                x_i++\n              y += checkersSize\n              y_i++\n          true then (data = @imageData?) then\n            x_s = sizeX * factorX\n            y_s = sizeY * factorY\n            x_i = 0\n            y_i = 0\n            y = 0\n            while y < y_s\n              x = 0\n              x_i = 0\n              while x < x_s\n                p = @pixelColor(x_i, y_i)\n                ctx.fillStyle = \"rgba(#{p[0]},#{p[1]},#{p[2]},#{p[3]/255})\"\n                ctx.fillRect x, y, factorX, factorY\n                x += factorX\n                x_i++\n              y += factorY\n              y_i++\n          if gridSize > 0\n            x = 0\n            while x <= sizeX\n              ctx.fillStyle = \"#{@borderColor}\"\n              ctx.fillRect(x * factorX, 0, gridSize, sizeY * factorY)\n              x++\n            y = 0\n            while y <= sizeY\n              ctx.fillStyle = \"#{@borderColor}\"\n              ctx.fillRect(0, y * factorY, sizeX * factorX, gridSize)\n              y++\n          return\n        ";
            return x;
          })(function() {
            var canvasSizeX, canvasSizeY, checkersSize, ctx, data, factor, factorX, factorY, gridSize, iconData, p, sizeX, sizeY, x, x_i, x_s, y, y_i, y_s;
            gridSize = this.gridSize, factor = this.factor, factorY = this.factorY, sizeY = this.sizeY, factorX = this.factorX, sizeX = this.sizeX, checkersSize = this.checkersSize;
            canvasSizeX = factorX * sizeX + gridSize;
            canvasSizeY = factorY * sizeY + gridSize;
            if (canvasSizeX !== this.el.width) {
              this.el.width = canvasSizeX;
            }
            if (canvasSizeY !== this.el.height) {
              this.el.height = canvasSizeY;
            }
            iconData = this.icon.getData();
            ctx = this.el.getContext("2d");
            if (checkersSize > 0 && checkersSize * 2 <= factor) {
              x_s = sizeX * factorX;
              y_s = sizeY * factorY;
              x_i = 0;
              y_i = 0;
              y = 0;
              while (y < y_s) {
                x = 0;
                x_i = 0;
                while (x < x_s) {
                  ctx.fillStyle = "" + ["181818", "303030"][(x_i ^ y_i) & 1];
                  ctx.fillRect(x, y, checkersSize, checkersSize);
                  x += checkersSize;
                  x_i++;
                }
                y += checkersSize;
                y_i++;
              }
            }
            if (true) {
              if ((data = this.imageData != null)) {
                x_s = sizeX * factorX;
                y_s = sizeY * factorY;
                x_i = 0;
                y_i = 0;
                y = 0;
                while (y < y_s) {
                  x = 0;
                  x_i = 0;
                  while (x < x_s) {
                    p = this.pixelColor(x_i, y_i);
                    ctx.fillStyle = "rgba(" + p[0] + "," + p[1] + "," + p[2] + "," + (p[3] / 255) + ")";
                    ctx.fillRect(x, y, factorX, factorY);
                    x += factorX;
                    x_i++;
                  }
                  y += factorY;
                  y_i++;
                }
              }
            }
            if (gridSize > 0) {
              x = 0;
              while (x <= sizeX) {
                ctx.fillStyle = "" + this.borderColor;
                ctx.fillRect(x * factorX, 0, gridSize, sizeY * factorY);
                x++;
              }
              y = 0;
              while (y <= sizeY) {
                ctx.fillStyle = "" + this.borderColor;
                ctx.fillRect(0, y * factorY, sizeX * factorX, gridSize);
                y++;
              }
            }
          }),
          load: (function(x) {
            x.coffee = "(imageData)@>\n            @addFrame?()\n            @icon.setImage(imageData)\n            @imageData = imageData\n            @redraw()\n            unless @sizeX is imageData.width and @sizeY is imageData.height\n                @sizeX = imageData.width\n                @sizeY = imageData.height\n            @imageData = imageData\n            @redraw()\n        ";
            return x;
          })(function(imageData) {
            if (typeof this.addFrame === "function") {
              this.addFrame();
            }
            this.icon.setImage(imageData);
            this.imageData = imageData;
            this.redraw();
            if (!(this.sizeX === imageData.width && this.sizeY === imageData.height)) {
              this.sizeX = imageData.width;
              this.sizeY = imageData.height;
            }
            this.imageData = imageData;
            return this.redraw();
          }),
          pixelColor: (function(x) {
            x.coffee = "(x,y)@>\n                { imageData: d } = @\n                i = (d.width * y + x) * 4\n                b = d.data\n                [ b[i], b[i+1], b[i+2], b[i+3] ]\n        ";
            return x;
          })(function(x, y) {
            var b, d, i;
            d = this.imageData;
            i = (d.width * y + x) * 4;
            b = d.data;
            return [b[i], b[i + 1], b[i + 2], b[i + 3]];
          }),
          zoomIn: (function(x) {
            x.coffee = "@>\n          @factorX = @factorY = ++@factor\n          @redraw()\n        ";
            return x;
          })(function() {
            this.factorX = this.factorY = ++this.factor;
            return this.redraw();
          }),
          zoomOut: (function(x) {
            x.coffee = "@>\n          @factorX = @factorY = --@factor\n          @redraw()\n        ";
            return x;
          })(function() {
            this.factorX = this.factorY = --this.factor;
            return this.redraw();
          }),
          view: {},
          lib: {
            htmlcup: window.htmlcup,
            document: document,
            window: window,
            setTimeout: setTimeout,
            FileReader: FileReader,
            Math: Math,
            color: colorLib,
            sliderInput: sliderInput,
            $: $
          },
          currentDialog: null,
          setDialog: (function(x) {
            x.coffee = "(name, x)@>\n            return unless @view?.dialogs?\n            c = @view.dialogs.firstChild then @lib.window.deleteNode c\n            @currentDialog = name\n            return unless x?\n            d = @lib.htmlcup.captureFirstTag ->\n              @div class:\"spiritcaseDialog\", ->\n                # @div style:\"width:0\", ->\n                    @div style:\"display:inline-block\", ->\n                        x.call @\n                    @div style:\"display:inline-block\", onclick:\"deleteNode(this.parentNode)\", class:\"spiritcaseDeleteDialog\", \"×\"\n            @view.dialogs.appendChild d\n\n        ";
            return x;
          })(function(name, x) {
            var c, d, _ref;
            if (((_ref = this.view) != null ? _ref.dialogs : void 0) == null) {
              return;
            }
            if (c = this.view.dialogs.firstChild) {
              this.lib.window.deleteNode(c);
            }
            this.currentDialog = name;
            if (x == null) {
              return;
            }
            d = this.lib.htmlcup.captureFirstTag(function() {
              return this.div({
                "class": "spiritcaseDialog"
              }, function() {
                this.div({
                  style: "display:inline-block"
                }, function() {
                  return x.call(this);
                });
                return this.div({
                  style: "display:inline-block",
                  onclick: "deleteNode(this.parentNode)",
                  "class": "spiritcaseDeleteDialog"
                }, "×");
              });
            });
            return this.view.dialogs.appendChild(d);
          }),
          loadButtonClick: (function(x) {
            x.coffee = "@>\n            spiritcase = @\n            @setDialog \"loadFile\", ->\n                @label \"Load file: \"\n                @input type:\"file\", onchange:\"javascript:spiritcase.loadFile(event)\"\n\n        ";
            return x;
          })(function() {
            var spiritcase;
            spiritcase = this;
            return this.setDialog("loadFile", function() {
              this.label("Load file: ");
              return this.input({
                type: "file",
                onchange: "javascript:spiritcase.loadFile(event)"
              });
            });
          }),
          saveButtonClick: (function(x) {
            x.coffee = "@>\n            @load @imageData\n            uri = @icon.el.toDataURL()\n            spiritcase = @\n            @setDialog \"saveFile\", ->\n                @label \"Download: \"\n                @a download:\"file\", href:uri, style:\"font-size:150%\", \"file.png\"\n                \n        ";
            return x;
          })(function() {
            var spiritcase, uri;
            this.load(this.imageData);
            uri = this.icon.el.toDataURL();
            spiritcase = this;
            return this.setDialog("saveFile", function() {
              this.label("Download: ");
              return this.a({
                download: "file",
                href: uri,
                style: "font-size:150%"
              }, "file.png");
            });
          }),
          nextTick: (function(x) {
            x.coffee = "(x)@>\n            { setTimeout } = @lib\n            setTimeout (=> x.call @), 0\n\n        ";
            return x;
          })(function(x) {
            var setTimeout;
            setTimeout = this.lib.setTimeout;
            return setTimeout(((function(_this) {
              return function() {
                return x.call(_this);
              };
            })(this)), 0);
          }),
          loadDataUrl: (function(x) {
            x.coffee = "(d)@>\n                              img = @lib.document.createElement 'img'\n                              img.src = d\n                              @nextTick ->\n                                  canvas = @lib.document.createElement 'canvas'\n                                  canvas.width = img.width\n                                  canvas.height = img.height\n                                  context = canvas.getContext '2d'\n                                  context.drawImage(img, 0, 0)\n                                  @load context.getImageData(0, 0, canvas.width, canvas.height)\n\n        ";
            return x;
          })(function(d) {
            var img;
            img = this.lib.document.createElement('img');
            img.src = d;
            return this.nextTick(function() {
              var canvas, context;
              canvas = this.lib.document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              context = canvas.getContext('2d');
              context.drawImage(img, 0, 0);
              return this.load(context.getImageData(0, 0, canvas.width, canvas.height));
            });
          }),
          loadFile: (function(x) {
            x.coffee = "(event)@>\n            for file in event.target.files\n                                  do (file)=>\n                                      r = new @lib.FileReader\n                                      r.onload = (event)=>\n                                           @loadDataUrl event.target.result\n                                      r.readAsDataURL(file)\n        ";
            return x;
          })(function(event) {
            var file, _i, _len, _ref, _results;
            _ref = event.target.files;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              file = _ref[_i];
              _results.push((function(_this) {
                return function(file) {
                  var r;
                  r = new _this.lib.FileReader;
                  r.onload = function(event) {
                    return _this.loadDataUrl(event.target.result);
                  };
                  return r.readAsDataURL(file);
                };
              })(this)(file));
            }
            return _results;
          }),
          withColorinput: (function(x) {
            x.coffee = "(input)@>\n            @colorinput =\n                input: input\n                spiritcase: @\n                onfocus: @>\n                    { spiritcase }   = @\n                    { sliderInput }  = @spiritcase.lib\n                    @spiritcase.setDialog \"selectColor\", ->\n                        color = (n)=>\n                            @div style:\"font-size:150%;background:##{n};color:#786;width:1.5em;display:inline-block\", class:\"paletteEntry\", onclick:\"javascript:spiritcase.setToolColorHex('#{n}')\", \"#{n}\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                          sliderInput.build\n                                    htmlcup: @\n                                    label: \"Opacity\"\n                                    value: \"#{spiritcase.toolAlpha*100 + 0.5 | 0}%\"\n                                    bar: spiritcase.toolAlpha\n                                    width:\"4em\"\n                                    # noBar: true\n                                    buildModule: (sliderInput)-> spiritcase.makeWebmodule \"sliderInputOpacity\", ->\n                                        spiritcase: @\n                                        __proto__: sliderInput\n                                        incScale: 1.035\n                                        incDelta: 0.008\n                                        incButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha * @incScale + @incDelta\n                                          @spiritcase.toolAlpha > 1 then @spiritcase.toolAlpha = 1\n                                          @refresh(el)\n                                        decButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha / @incScale - @incDelta\n                                          @spiritcase.toolAlpha < 0 then @spiritcase.toolAlpha = 0\n                                          @refresh(el)\n                                        barSet: (bar,el)@>\n                                          @spiritcase.toolAlpha = bar\n                                          @refresh(el)\n                                        refresh: (el)@>\n                                          @setView el,\n                                            text: \"#{@spiritcase.toolAlpha*100 + 0.5 | 0}%\"\n                                            bar: @spiritcase.toolAlpha\n                                        $: @lib.$\n                          colorComponentSlider = ({ i, label, barColor })=> sliderInput.build\n                                    htmlcup: @\n                                    label: label\n                                    barColor: barColor\n                                    value: \"#{(spiritcase.toolColor[i]/255)*100 + 0.5 | 0}%\"\n                                    bar: spiritcase.toolColor[i]/255\n                                    width:\"4em\"\n                                    # noBar: true\n                                    buildModule: (sliderInput)-> spiritcase.makeWebmodule \"sliderInput#{label}\", ->\n                                        spiritcase: @\n                                        __proto__: sliderInput\n                                        colorComponentIndex: i\n                                        getComponent: @> @spiritcase.toolColor[@colorComponentIndex]/255\n                                        setComponent: (v)@>\n                                          c = @spiritcase.toolColor\n                                          c[@colorComponentIndex] = v*255 + 0.5 | 0\n                                          @spiritcase.setToolColor c\n                                        incScale: 1.035\n                                        incDelta: 0.008\n                                        incButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() * @incScale + @incDelta\n                                          c > 1 then c = 1\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        decButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() / @incScale - @incDelta\n                                          c < 0 then c = 0\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        barSet: (bar,el)@>\n                                          @setComponent(bar)\n                                          @refresh(el)\n                                        refresh: (el)@>\n                                          c = @getComponent()\n                                          @setView el,\n                                            text: \"#{c*100 + 0.5 | 0}%\"\n                                            bar: c\n                                        $: @lib.$\n                          colorComponentSlider i:0, label: \"Red\",    barColor: \"red\"\n                          colorComponentSlider i:1, label: \"Green\",  barColor: \"green\"\n                          colorComponentSlider i:2, label: \"Blue\",   barColor: \"blue\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                            color \"000\"\n                            color \"fff\"\n                            color \"f00\"\n                            color \"0f0\"\n                            color \"00f\"\n                            color \"ff0\"\n                            color \"f0f\"\n                            color \"0ff\"\n                            # @button \"Add\", onclick:\"javascript:spiritcase.colorinput.saveCurrentColor()\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                            @button \"Pick\", onclick:\"javascript:spiritcase.setColorPickerTool()\"\n                editingValue: false\n                setColor: (c)@>\n                        @input.setAttribute \"style\", \"background:##{c}\"\n                        unless @editingValue\n                            @input.value = \"##{c}\"\n                oninput: @>\n                    v = @input.value\n                    m = /^\\s*#?((?:[0-9a-fA-F]{3}){1,2})\\s*$/.exec v then\n                        try\n                            @editingValue = true\n                            @spiritcase.setToolColorHex m[1]\n                        finally\n                            @editingValue = false\n                lib: @lib\n        ";
            return x;
          })(function(input) {
            return this.colorinput = {
              input: input,
              spiritcase: this,
              onfocus: (function(x) {
                x.coffee = "@>\n                    { spiritcase }   = @\n                    { sliderInput }  = @spiritcase.lib\n                    @spiritcase.setDialog \"selectColor\", ->\n                        color = (n)=>\n                            @div style:\"font-size:150%;background:##{n};color:#786;width:1.5em;display:inline-block\", class:\"paletteEntry\", onclick:\"javascript:spiritcase.setToolColorHex('#{n}')\", \"#{n}\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                          sliderInput.build\n                                    htmlcup: @\n                                    label: \"Opacity\"\n                                    value: \"#{spiritcase.toolAlpha*100 + 0.5 | 0}%\"\n                                    bar: spiritcase.toolAlpha\n                                    width:\"4em\"\n                                    # noBar: true\n                                    buildModule: (sliderInput)-> spiritcase.makeWebmodule \"sliderInputOpacity\", ->\n                                        spiritcase: @\n                                        __proto__: sliderInput\n                                        incScale: 1.035\n                                        incDelta: 0.008\n                                        incButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha * @incScale + @incDelta\n                                          @spiritcase.toolAlpha > 1 then @spiritcase.toolAlpha = 1\n                                          @refresh(el)\n                                        decButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha / @incScale - @incDelta\n                                          @spiritcase.toolAlpha < 0 then @spiritcase.toolAlpha = 0\n                                          @refresh(el)\n                                        barSet: (bar,el)@>\n                                          @spiritcase.toolAlpha = bar\n                                          @refresh(el)\n                                        refresh: (el)@>\n                                          @setView el,\n                                            text: \"#{@spiritcase.toolAlpha*100 + 0.5 | 0}%\"\n                                            bar: @spiritcase.toolAlpha\n                                        $: @lib.$\n                          colorComponentSlider = ({ i, label, barColor })=> sliderInput.build\n                                    htmlcup: @\n                                    label: label\n                                    barColor: barColor\n                                    value: \"#{(spiritcase.toolColor[i]/255)*100 + 0.5 | 0}%\"\n                                    bar: spiritcase.toolColor[i]/255\n                                    width:\"4em\"\n                                    # noBar: true\n                                    buildModule: (sliderInput)-> spiritcase.makeWebmodule \"sliderInput#{label}\", ->\n                                        spiritcase: @\n                                        __proto__: sliderInput\n                                        colorComponentIndex: i\n                                        getComponent: @> @spiritcase.toolColor[@colorComponentIndex]/255\n                                        setComponent: (v)@>\n                                          c = @spiritcase.toolColor\n                                          c[@colorComponentIndex] = v*255 + 0.5 | 0\n                                          @spiritcase.setToolColor c\n                                        incScale: 1.035\n                                        incDelta: 0.008\n                                        incButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() * @incScale + @incDelta\n                                          c > 1 then c = 1\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        decButton: (ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() / @incScale - @incDelta\n                                          c < 0 then c = 0\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        barSet: (bar,el)@>\n                                          @setComponent(bar)\n                                          @refresh(el)\n                                        refresh: (el)@>\n                                          c = @getComponent()\n                                          @setView el,\n                                            text: \"#{c*100 + 0.5 | 0}%\"\n                                            bar: c\n                                        $: @lib.$\n                          colorComponentSlider i:0, label: \"Red\",    barColor: \"red\"\n                          colorComponentSlider i:1, label: \"Green\",  barColor: \"green\"\n                          colorComponentSlider i:2, label: \"Blue\",   barColor: \"blue\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                            color \"000\"\n                            color \"fff\"\n                            color \"f00\"\n                            color \"0f0\"\n                            color \"00f\"\n                            color \"ff0\"\n                            color \"f0f\"\n                            color \"0ff\"\n                            # @button \"Add\", onclick:\"javascript:spiritcase.colorinput.saveCurrentColor()\"\n                        @div class:\"spiritcaseToolbarGroup\", ->\n                            @button \"Pick\", onclick:\"javascript:spiritcase.setColorPickerTool()\"\n                ";
                return x;
              })(function() {
                var sliderInput, spiritcase;
                spiritcase = this.spiritcase;
                sliderInput = this.spiritcase.lib.sliderInput;
                return this.spiritcase.setDialog("selectColor", function() {
                  var color;
                  color = (function(_this) {
                    return function(n) {
                      return _this.div({
                        style: "font-size:150%;background:#" + n + ";color:#786;width:1.5em;display:inline-block",
                        "class": "paletteEntry",
                        onclick: "javascript:spiritcase.setToolColorHex('" + n + "')"
                      }, "" + n);
                    };
                  })(this);
                  this.div({
                    "class": "spiritcaseToolbarGroup"
                  }, function() {
                    var colorComponentSlider;
                    sliderInput.build({
                      htmlcup: this,
                      label: "Opacity",
                      value: "" + (spiritcase.toolAlpha * 100 + 0.5 | 0) + "%",
                      bar: spiritcase.toolAlpha,
                      width: "4em",
                      buildModule: function(sliderInput) {
                        return spiritcase.makeWebmodule("sliderInputOpacity", function() {
                          return {
                            spiritcase: this,
                            __proto__: sliderInput,
                            incScale: 1.035,
                            incDelta: 0.008,
                            incButton: (function(x) {
                              x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha * @incScale + @incDelta\n                                          @spiritcase.toolAlpha > 1 then @spiritcase.toolAlpha = 1\n                                          @refresh(el)\n                                        ";
                              return x;
                            })(function(ev, el) {
                              this.terminateEvent(ev);
                              this.spiritcase.toolAlpha = this.spiritcase.toolAlpha * this.incScale + this.incDelta;
                              if (this.spiritcase.toolAlpha > 1) {
                                this.spiritcase.toolAlpha = 1;
                              }
                              return this.refresh(el);
                            }),
                            decButton: (function(x) {
                              x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.toolAlpha = @spiritcase.toolAlpha / @incScale - @incDelta\n                                          @spiritcase.toolAlpha < 0 then @spiritcase.toolAlpha = 0\n                                          @refresh(el)\n                                        ";
                              return x;
                            })(function(ev, el) {
                              this.terminateEvent(ev);
                              this.spiritcase.toolAlpha = this.spiritcase.toolAlpha / this.incScale - this.incDelta;
                              if (this.spiritcase.toolAlpha < 0) {
                                this.spiritcase.toolAlpha = 0;
                              }
                              return this.refresh(el);
                            }),
                            barSet: (function(x) {
                              x.coffee = "(bar,el)@>\n                                          @spiritcase.toolAlpha = bar\n                                          @refresh(el)\n                                        ";
                              return x;
                            })(function(bar, el) {
                              this.spiritcase.toolAlpha = bar;
                              return this.refresh(el);
                            }),
                            refresh: (function(x) {
                              x.coffee = "(el)@>\n                                          @setView el,\n                                            text: \"#{@spiritcase.toolAlpha*100 + 0.5 | 0}%\"\n                                            bar: @spiritcase.toolAlpha\n                                        ";
                              return x;
                            })(function(el) {
                              return this.setView(el, {
                                text: "" + (this.spiritcase.toolAlpha * 100 + 0.5 | 0) + "%",
                                bar: this.spiritcase.toolAlpha
                              });
                            }),
                            $: this.lib.$
                          };
                        });
                      }
                    });
                    colorComponentSlider = (function(_this) {
                      return function(_arg) {
                        var barColor, i, label;
                        i = _arg.i, label = _arg.label, barColor = _arg.barColor;
                        return sliderInput.build({
                          htmlcup: _this,
                          label: label,
                          barColor: barColor,
                          value: "" + ((spiritcase.toolColor[i] / 255) * 100 + 0.5 | 0) + "%",
                          bar: spiritcase.toolColor[i] / 255,
                          width: "4em",
                          buildModule: function(sliderInput) {
                            return spiritcase.makeWebmodule("sliderInput" + label, function() {
                              return {
                                spiritcase: this,
                                __proto__: sliderInput,
                                colorComponentIndex: i,
                                getComponent: (function(x) {
                                  x.coffee = "@> @spiritcase.toolColor[@colorComponentIndex]/255";
                                  return x;
                                })(function() {
                                  return this.spiritcase.toolColor[this.colorComponentIndex] / 255;
                                }),
                                setComponent: (function(x) {
                                  x.coffee = "(v)@>\n                                          c = @spiritcase.toolColor\n                                          c[@colorComponentIndex] = v*255 + 0.5 | 0\n                                          @spiritcase.setToolColor c\n                                        ";
                                  return x;
                                })(function(v) {
                                  var c;
                                  c = this.spiritcase.toolColor;
                                  c[this.colorComponentIndex] = v * 255 + 0.5 | 0;
                                  return this.spiritcase.setToolColor(c);
                                }),
                                incScale: 1.035,
                                incDelta: 0.008,
                                incButton: (function(x) {
                                  x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() * @incScale + @incDelta\n                                          c > 1 then c = 1\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        ";
                                  return x;
                                })(function(ev, el) {
                                  var c;
                                  this.terminateEvent(ev);
                                  c = this.getComponent() * this.incScale + this.incDelta;
                                  if (c > 1) {
                                    c = 1;
                                  }
                                  this.setComponent(c);
                                  return this.refresh(el);
                                }),
                                decButton: (function(x) {
                                  x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          c = @getComponent() / @incScale - @incDelta\n                                          c < 0 then c = 0\n                                          @setComponent(c)\n                                          @refresh(el)\n                                        ";
                                  return x;
                                })(function(ev, el) {
                                  var c;
                                  this.terminateEvent(ev);
                                  c = this.getComponent() / this.incScale - this.incDelta;
                                  if (c < 0) {
                                    c = 0;
                                  }
                                  this.setComponent(c);
                                  return this.refresh(el);
                                }),
                                barSet: (function(x) {
                                  x.coffee = "(bar,el)@>\n                                          @setComponent(bar)\n                                          @refresh(el)\n                                        ";
                                  return x;
                                })(function(bar, el) {
                                  this.setComponent(bar);
                                  return this.refresh(el);
                                }),
                                refresh: (function(x) {
                                  x.coffee = "(el)@>\n                                          c = @getComponent()\n                                          @setView el,\n                                            text: \"#{c*100 + 0.5 | 0}%\"\n                                            bar: c\n                                        ";
                                  return x;
                                })(function(el) {
                                  var c;
                                  c = this.getComponent();
                                  return this.setView(el, {
                                    text: "" + (c * 100 + 0.5 | 0) + "%",
                                    bar: c
                                  });
                                }),
                                $: this.lib.$
                              };
                            });
                          }
                        });
                      };
                    })(this);
                    colorComponentSlider({
                      i: 0,
                      label: "Red",
                      barColor: "red"
                    });
                    colorComponentSlider({
                      i: 1,
                      label: "Green",
                      barColor: "green"
                    });
                    return colorComponentSlider({
                      i: 2,
                      label: "Blue",
                      barColor: "blue"
                    });
                  });
                  this.div({
                    "class": "spiritcaseToolbarGroup"
                  }, function() {
                    color("000");
                    color("fff");
                    color("f00");
                    color("0f0");
                    color("00f");
                    color("ff0");
                    color("f0f");
                    return color("0ff");
                  });
                  return this.div({
                    "class": "spiritcaseToolbarGroup"
                  }, function() {
                    return this.button("Pick", {
                      onclick: "javascript:spiritcase.setColorPickerTool()"
                    });
                  });
                });
              }),
              editingValue: false,
              setColor: (function(x) {
                x.coffee = "(c)@>\n                        @input.setAttribute \"style\", \"background:##{c}\"\n                        unless @editingValue\n                            @input.value = \"##{c}\"\n                ";
                return x;
              })(function(c) {
                this.input.setAttribute("style", "background:#" + c);
                if (!this.editingValue) {
                  return this.input.value = "#" + c;
                }
              }),
              oninput: (function(x) {
                x.coffee = "@>\n                    v = @input.value\n                    m = /^\\s*#?((?:[0-9a-fA-F]{3}){1,2})\\s*$/.exec v then\n                        try\n                            @editingValue = true\n                            @spiritcase.setToolColorHex m[1]\n                        finally\n                            @editingValue = false\n                ";
                return x;
              })(function() {
                var m, v;
                v = this.input.value;
                if (m = /^\s*#?((?:[0-9a-fA-F]{3}){1,2})\s*$/.exec(v)) {
                  try {
                    this.editingValue = true;
                    return this.spiritcase.setToolColorHex(m[1]);
                  } finally {
                    this.editingValue = false;
                  }
                }
              }),
              lib: this.lib
            };
          }),
          toolColor: [Math.round(100 + Math.random() * 155), Math.round(100 + Math.random() * 155), Math.round(100 + Math.random() * 155)],
          toolAlpha: 0.3,
          setColorPickerTool: (function(x) {
            x.coffee = "@>";
            return x;
          })(function() {}),
          setToolColorHex: (function(x) {
            x.coffee = "(c)@>\n            if @tool.name is \"erase\"\n              @paintButtonClick noSetdialog: 1\n            @toolColor = @lib.color.hex2rgb c\n            @colorinput.setColor(c)\n            @\n        ";
            return x;
          })(function(c) {
            if (this.tool.name === "erase") {
              this.paintButtonClick({
                noSetdialog: 1
              });
            }
            this.toolColor = this.lib.color.hex2rgb(c);
            this.colorinput.setColor(c);
            return this;
          }),
          setToolColor: (function(x) {
            x.coffee = "(c)@>\n            if @tool.name is \"erase\"\n              @paintButtonClick noSetdialog: 1\n            @toolColor = c\n            @colorinput.setColor(@lib.color.rgb2hex(c))\n            @\n\n        ";
            return x;
          })(function(c) {
            if (this.tool.name === "erase") {
              this.paintButtonClick({
                noSetdialog: 1
              });
            }
            this.toolColor = c;
            this.colorinput.setColor(this.lib.color.rgb2hex(c));
            return this;
          }),
          paintButtonClick: (function(x) {
            x.coffee = "(opts)@>\n          @lib.$(\"#spiritcaseEraseButton\")[0]?.classList.remove(\"activated\")\n          @lib.$(\"#spiritcasePaintButton\")[0]?.classList.add(\"activated\")\n          @setDialog() unless opts?.noSetdialog\n          @tool =\n              name: \"paint\"\n              spiritcase: @\n              employ: (x,y)@>\n                  x = x|0\n                  y = y|0\n                  return if x is @x and y is @y\n                  @x = x\n                  @y = y\n                  @spiritcase.setPixel x, y, @spiritcase.toolColor, @spiritcase.toolAlpha\n                  @spiritcase.redrawPixel x, y\n              done: @>\n                  @x = @y = null\n\n        ";
            return x;
          })(function(opts) {
            var _ref, _ref1;
            if ((_ref = this.lib.$("#spiritcaseEraseButton")[0]) != null) {
              _ref.classList.remove("activated");
            }
            if ((_ref1 = this.lib.$("#spiritcasePaintButton")[0]) != null) {
              _ref1.classList.add("activated");
            }
            if (!(opts != null ? opts.noSetdialog : void 0)) {
              this.setDialog();
            }
            return this.tool = {
              name: "paint",
              spiritcase: this,
              employ: (function(x) {
                x.coffee = "(x,y)@>\n                  x = x|0\n                  y = y|0\n                  return if x is @x and y is @y\n                  @x = x\n                  @y = y\n                  @spiritcase.setPixel x, y, @spiritcase.toolColor, @spiritcase.toolAlpha\n                  @spiritcase.redrawPixel x, y\n              ";
                return x;
              })(function(x, y) {
                x = x | 0;
                y = y | 0;
                if (x === this.x && y === this.y) {
                  return;
                }
                this.x = x;
                this.y = y;
                this.spiritcase.setPixel(x, y, this.spiritcase.toolColor, this.spiritcase.toolAlpha);
                return this.spiritcase.redrawPixel(x, y);
              }),
              done: (function(x) {
                x.coffee = "@>\n                  @x = @y = null\n\n        ";
                return x;
              })(function() {
                return this.x = this.y = null;
              })
            };
          }),
          eraseButtonClick: (function(x) {
            x.coffee = "@>\n          @lib.$(\"#spiritcasePaintButton\")[0]?.classList.remove(\"activated\")\n          @lib.$(\"#spiritcaseEraseButton\")[0]?.classList.add(\"activated\")\n          @setDialog()\n          @tool =\n              name: \"erase\"\n              spiritcase: @\n              employ: (x,y)@>\n                  x = x|0\n                  y = y|0\n                  return if x is @x and y is @y\n                  @x = x\n                  @y = y\n                  # @spiritcase.setPixel x, y, @spiritcase.toolColor, @spiritcase.toolAlpha\n                  @spiritcase.unsetPixel x, y, @spiritcase.toolAlpha\n                  @spiritcase.redrawPixel x, y\n              done: @>\n                  @x = @y = null\n\n        ";
            return x;
          })(function() {
            var _ref, _ref1;
            if ((_ref = this.lib.$("#spiritcasePaintButton")[0]) != null) {
              _ref.classList.remove("activated");
            }
            if ((_ref1 = this.lib.$("#spiritcaseEraseButton")[0]) != null) {
              _ref1.classList.add("activated");
            }
            this.setDialog();
            return this.tool = {
              name: "erase",
              spiritcase: this,
              employ: (function(x) {
                x.coffee = "(x,y)@>\n                  x = x|0\n                  y = y|0\n                  return if x is @x and y is @y\n                  @x = x\n                  @y = y\n                  # @spiritcase.setPixel x, y, @spiritcase.toolColor, @spiritcase.toolAlpha\n                  @spiritcase.unsetPixel x, y, @spiritcase.toolAlpha\n                  @spiritcase.redrawPixel x, y\n              ";
                return x;
              })(function(x, y) {
                x = x | 0;
                y = y | 0;
                if (x === this.x && y === this.y) {
                  return;
                }
                this.x = x;
                this.y = y;
                this.spiritcase.unsetPixel(x, y, this.spiritcase.toolAlpha);
                return this.spiritcase.redrawPixel(x, y);
              }),
              done: (function(x) {
                x.coffee = "@>\n                  @x = @y = null\n\n        ";
                return x;
              })(function() {
                return this.x = this.y = null;
              })
            };
          }),
          setPixel: (function(x) {
            x.coffee = "(x,y,color,alpha)@>\n                { imageData: d } = @\n                nalpha = 1 - alpha\n                i = (d.width * y + x) * 4\n                b = d.data\n                rnd = @lib.Math.round\n                if false\n                    b[i] = rnd(color[0] * alpha + b[i] * nalpha)\n                    i++ \n                    b[i] = rnd(color[1] * alpha + b[i] * nalpha)\n                    i++\n                    b[i] = rnd(color[2] * alpha + b[i] * nalpha)\n                else\n                    calpha = alpha\n                    palpha = b[i+3]/255\n                    nalpha *= palpha\n                    alpha = 1 - nalpha\n                    b[i] = rnd(color[0] * alpha + b[i] * nalpha)\n                    i++ \n                    b[i] = rnd(color[1] * alpha + b[i] * nalpha)\n                    i++\n                    b[i] = rnd(color[2] * alpha + b[i] * nalpha)\n                    i++\n                    b[i] = rnd(255 * (1 - (1 - palpha) * (1 - calpha)))\n                \n        ";
            return x;
          })(function(x, y, color, alpha) {
            var b, calpha, d, i, nalpha, palpha, rnd;
            d = this.imageData;
            nalpha = 1 - alpha;
            i = (d.width * y + x) * 4;
            b = d.data;
            rnd = this.lib.Math.round;
            if (false) {
              b[i] = rnd(color[0] * alpha + b[i] * nalpha);
              i++;
              b[i] = rnd(color[1] * alpha + b[i] * nalpha);
              i++;
              return b[i] = rnd(color[2] * alpha + b[i] * nalpha);
            } else {
              calpha = alpha;
              palpha = b[i + 3] / 255;
              nalpha *= palpha;
              alpha = 1 - nalpha;
              b[i] = rnd(color[0] * alpha + b[i] * nalpha);
              i++;
              b[i] = rnd(color[1] * alpha + b[i] * nalpha);
              i++;
              b[i] = rnd(color[2] * alpha + b[i] * nalpha);
              i++;
              return b[i] = rnd(255 * (1 - (1 - palpha) * (1 - calpha)));
            }
          }),
          unsetPixel: (function(x) {
            x.coffee = "(x,y,alpha)@>\n                { imageData: d } = @\n                i = (d.width * y + x) * 4 + 3\n                b = d.data\n                rnd = @lib.Math.round\n                b[i] = rnd(b[i] * (1 - alpha))\n                \n        ";
            return x;
          })(function(x, y, alpha) {
            var b, d, i, rnd;
            d = this.imageData;
            i = (d.width * y + x) * 4 + 3;
            b = d.data;
            rnd = this.lib.Math.round;
            return b[i] = rnd(b[i] * (1 - alpha));
          }),
          redrawPixel: (function(x) {
            x.coffee = "(x,y)@>\n          { gridSize, factor, factorY, sizeY, factorX, sizeX, checkersSize } = @\n          ctx = @el.getContext \"2d\"\n          p = @pixelColor(x, y)\n          # ctx.fillStyle = (0x1000000 + (c[0] << 16) + (c[1] << 8) + c[2]).toString(16).substring(1) # '#330000' # @pixelColor(x_i, y_i)\n          x1 = x * factorX + gridSize\n          y1 = y * factorY + gridSize\n          x2 = factorX - gridSize\n          y2 = factorY - gridSize\n          ctx.clearRect x1, y1, x2, y2\n          ctx.fillStyle = \"rgba(#{p[0]},#{p[1]},#{p[2]},#{p[3]/255})\"\n          ctx.fillRect x1, y1, x2, y2\n          @\n\n        ";
            return x;
          })(function(x, y) {
            var checkersSize, ctx, factor, factorX, factorY, gridSize, p, sizeX, sizeY, x1, x2, y1, y2;
            gridSize = this.gridSize, factor = this.factor, factorY = this.factorY, sizeY = this.sizeY, factorX = this.factorX, sizeX = this.sizeX, checkersSize = this.checkersSize;
            ctx = this.el.getContext("2d");
            p = this.pixelColor(x, y);
            x1 = x * factorX + gridSize;
            y1 = y * factorY + gridSize;
            x2 = factorX - gridSize;
            y2 = factorY - gridSize;
            ctx.clearRect(x1, y1, x2, y2);
            ctx.fillStyle = "rgba(" + p[0] + "," + p[1] + "," + p[2] + "," + (p[3] / 255) + ")";
            ctx.fillRect(x1, y1, x2, y2);
            return this;
          }),
          modified: true,
          mousedown: 0,
          employMouse: (function(x) {
            x.coffee = "(el, event, isFirst)@>\n          @checkpoint(\"employMouse\") if @modified and isFirst and @modified isnt \"doneMouse\"\n          { gridSize, factor, factorY, sizeY, factorX, sizeX, checkersSize } = @\n          h = gridSize / 2\n          x = event.clientX - el.offsetLeft - gridSize\n          y = event.clientY - el.offsetTop - gridSize\n          @tool?.employ(x / factorX, y / factorY)\n\n        ";
            return x;
          })(function(el, event, isFirst) {
            var checkersSize, factor, factorX, factorY, gridSize, h, sizeX, sizeY, x, y, _ref;
            if (this.modified && isFirst && this.modified !== "doneMouse") {
              this.checkpoint("employMouse");
            }
            gridSize = this.gridSize, factor = this.factor, factorY = this.factorY, sizeY = this.sizeY, factorX = this.factorX, sizeX = this.sizeX, checkersSize = this.checkersSize;
            h = gridSize / 2;
            x = event.clientX - el.offsetLeft - gridSize;
            y = event.clientY - el.offsetTop - gridSize;
            return (_ref = this.tool) != null ? _ref.employ(x / factorX, y / factorY) : void 0;
          }),
          doneMouse: (function(x) {
            x.coffee = "(el, event, isLast)@>\n          @tool?.done?()\n          @updateIcon()\n          if isLast\n            @modified = \"doneMouse\"\n            @scheduleCheckpoint(\"doneMouse\")\n\n        ";
            return x;
          })(function(el, event, isLast) {
            var _ref;
            if ((_ref = this.tool) != null) {
              if (typeof _ref.done === "function") {
                _ref.done();
              }
            }
            this.updateIcon();
            if (isLast) {
              this.modified = "doneMouse";
              return this.scheduleCheckpoint("doneMouse");
            }
          }),
          setup: (function(x) {
            x.coffee = "@>\n          @el.spiritcase = @\n          @imageData = @icon.getData()\n            # width: @sizeX\n            # height: @sizeY\n            # data: do=>\n            #   m = @sizeX * @sizeY * 4\n            #   x = [ ]\n            #   x.push 0 while m-- > 0\n            #   x\n\n          @redraw()\n          @paintButtonClick()\n\n          @el.onmousemove = (event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            if @spiritcase.mousedown > 0\n                @spiritcase.employMouse @, event, false\n          @el.onmouseup = (event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            @spiritcase.employMouse @, event, false\n            unless @spiritcase.mousedown <= 0\n              @spiritcase.mousedown--\n              unless @spiritcase.mousedown > 0\n                @spiritcase.doneMouse(@, event, true)\n          @el.onmousedown = (event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            @spiritcase.employMouse @, event, 0 is @spiritcase.mousedown++\n          @el.onmouseout = (event)@>\n            @spiritcase.doneMouse(@, event, @spiritcase.mousedown > 0)\n            @spiritcase.mousedown = 0\n          @\n        ";
            return x;
          })(function() {
            this.el.spiritcase = this;
            this.imageData = this.icon.getData();
            this.redraw();
            this.paintButtonClick();
            this.el.onmousemove = (function(x) {
              x.coffee = "(event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            if @spiritcase.mousedown > 0\n                @spiritcase.employMouse @, event, false\n          ";
              return x;
            })(function(event) {
              event.stopPropagation();
              event.preventDefault();
              if (this.spiritcase.mousedown > 0) {
                return this.spiritcase.employMouse(this, event, false);
              }
            });
            this.el.onmouseup = (function(x) {
              x.coffee = "(event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            @spiritcase.employMouse @, event, false\n            unless @spiritcase.mousedown <= 0\n              @spiritcase.mousedown--\n              unless @spiritcase.mousedown > 0\n                @spiritcase.doneMouse(@, event, true)\n          ";
              return x;
            })(function(event) {
              event.stopPropagation();
              event.preventDefault();
              this.spiritcase.employMouse(this, event, false);
              if (!(this.spiritcase.mousedown <= 0)) {
                this.spiritcase.mousedown--;
                if (!(this.spiritcase.mousedown > 0)) {
                  return this.spiritcase.doneMouse(this, event, true);
                }
              }
            });
            this.el.onmousedown = (function(x) {
              x.coffee = "(event)@>\n            event.stopPropagation()\n            event.preventDefault()\n            @spiritcase.employMouse @, event, 0 is @spiritcase.mousedown++\n          ";
              return x;
            })(function(event) {
              event.stopPropagation();
              event.preventDefault();
              return this.spiritcase.employMouse(this, event, 0 === this.spiritcase.mousedown++);
            });
            this.el.onmouseout = (function(x) {
              x.coffee = "(event)@>\n            @spiritcase.doneMouse(@, event, @spiritcase.mousedown > 0)\n            @spiritcase.mousedown = 0\n          ";
              return x;
            })(function(event) {
              this.spiritcase.doneMouse(this, event, this.spiritcase.mousedown > 0);
              return this.spiritcase.mousedown = 0;
            });
            return this;
          }),
          makeWebmodule: (function(x) {
            x.coffee = "(name, build)@>\n            @webmodule ?= { }\n            @webmodule[name] = build.call @\n            \"spiritcase.webmodule.#{name}\"\n\n        ";
            return x;
          })(function(name, build) {
            if (this.webmodule == null) {
              this.webmodule = {};
            }
            this.webmodule[name] = build.call(this);
            return "spiritcase.webmodule." + name;
          }),
          maxCheckpoints: 40,
          checkpoints: [],
          checkpointsCounter: 0,
          updateIcon: (function(x) {
            x.coffee = "@>\n          @icon.setImage(@imageData)\n        ";
            return x;
          })(function() {
            return this.icon.setImage(this.imageData);
          }),
          checkpoint: (function(x) {
            x.coffee = "(name)@>\n          { console } = @lib.window\n          console.log \"checkpoint #{name}\"\n          (xx = @checkpointTimeout)? then\n            { clearTimeout } = @lib.window\n            clearTimeout xx\n            @checkpointTimeout = null\n          { Date } = @lib.window\n          canvas = @getAsCanvas()\n          @lastCheckpoint =\n                      time: new Date\n                      canvas: canvas\n                      counter: @checkpointsCounter++\n          @checkpoints.push @lastCheckpoint\n          if @checkpoints.length > @maxCheckpoints\n            for x in @checkpoints\n              x.generation = (x.generation ? 0) + 1\n            rest = @checkpoints.splice(@checkpoints / 2)\n            compressed = [ ]\n            for k,v of rest\n              if k & 1\n                compressed.push v\n            @checkpoints = @checkpoints.concat compressed\n          if !@currentDialog? or @currentDialog is \"undoHistory\"\n            @undoButtonClick(noCheckpoint: 1)\n          @modified = false\n        ";
            return x;
          })(function(name) {
            var Date, canvas, clearTimeout, compressed, console, k, rest, v, x, xx, _i, _len, _ref, _ref1;
            console = this.lib.window.console;
            console.log("checkpoint " + name);
            if ((xx = this.checkpointTimeout) != null) {
              clearTimeout = this.lib.window.clearTimeout;
              clearTimeout(xx);
              this.checkpointTimeout = null;
            }
            Date = this.lib.window.Date;
            canvas = this.getAsCanvas();
            this.lastCheckpoint = {
              time: new Date,
              canvas: canvas,
              counter: this.checkpointsCounter++
            };
            this.checkpoints.push(this.lastCheckpoint);
            if (this.checkpoints.length > this.maxCheckpoints) {
              _ref = this.checkpoints;
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                x = _ref[_i];
                x.generation = ((_ref1 = x.generation) != null ? _ref1 : 0) + 1;
              }
              rest = this.checkpoints.splice(this.checkpoints / 2);
              compressed = [];
              for (k in rest) {
                v = rest[k];
                if (k & 1) {
                  compressed.push(v);
                }
              }
              this.checkpoints = this.checkpoints.concat(compressed);
            }
            if ((this.currentDialog == null) || this.currentDialog === "undoHistory") {
              this.undoButtonClick({
                noCheckpoint: 1
              });
            }
            return this.modified = false;
          }),
          scheduleCheckpointDelay: 3000,
          scheduleCheckpoint: (function(x) {
            x.coffee = "(name)@>\n          return if @checkpointTimeout\n          { setTimeout } = @lib.window\n          @checkpointTimeout = setTimeout (=> @checkpointTimeout = null; @checkpoint(name)), @scheduleCheckpointDelay\n            \n        ";
            return x;
          })(function(name) {
            var setTimeout;
            if (this.checkpointTimeout) {
              return;
            }
            setTimeout = this.lib.window.setTimeout;
            return this.checkpointTimeout = setTimeout(((function(_this) {
              return function() {
                _this.checkpointTimeout = null;
                return _this.checkpoint(name);
              };
            })(this)), this.scheduleCheckpointDelay);
          }),
          undoButtonClick: (function(x) {
            x.coffee = "(opts)@>\n          if @modified\n            unless opts?.noCheckpoint\n              @checkpoint(\"undo\")\n          { $ } = @lib\n          @setDialog \"undoHistory\", ->\n            @label \"History: \"\n            @span class:\"undoHistory\"\n          $(\".undoHistory\").add (@setupUndoStep(v.canvas) for v in @checkpoints.concat([]).reverse())\n        ";
            return x;
          })(function(opts) {
            var $, v;
            if (this.modified) {
              if (!(opts != null ? opts.noCheckpoint : void 0)) {
                this.checkpoint("undo");
              }
            }
            $ = this.lib.$;
            this.setDialog("undoHistory", function() {
              this.label("History: ");
              return this.span({
                "class": "undoHistory"
              });
            });
            return $(".undoHistory").add((function() {
              var _i, _len, _ref, _results;
              _ref = this.checkpoints.concat([]).reverse();
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                v = _ref[_i];
                _results.push(this.setupUndoStep(v.canvas));
              }
              return _results;
            }).call(this));
          }),
          setupUndoStep: (function(x) {
            x.coffee = "(v)@>\n          v.setAttribute \"onclick\", \"javascript:spiritcase.chooseUndoStep(event,this)\"\n          v\n        ";
            return x;
          })(function(v) {
            v.setAttribute("onclick", "javascript:spiritcase.chooseUndoStep(event,this)");
            return v;
          }),
          chooseUndoStep: (function(x) {
            x.coffee = "(event, el1)@>\n            event.stopPropagation()\n            event.preventDefault()\n            @checkpoint(\"chooseUndoStep\") if @modified\n            @imageData = el1.getContext('2d').getImageData(0, 0, el1.width, el1.height)\n            @updateIcon()\n            @redraw()\n            @modified = true\n            \n        ";
            return x;
          })(function(event, el1) {
            event.stopPropagation();
            event.preventDefault();
            if (this.modified) {
              this.checkpoint("chooseUndoStep");
            }
            this.imageData = el1.getContext('2d').getImageData(0, 0, el1.width, el1.height);
            this.updateIcon();
            this.redraw();
            return this.modified = true;
          }),
          getAsCanvas: (function(x) {
            x.coffee = "@>\n          { document } = @lib.window\n          { imageData } = @\n          canvas = document.createElement \"canvas\"\n          canvas.height = imageData.height\n          canvas.width = imageData.width\n          ctx = canvas.getContext \"2d\"\n          ctx.putImageData imageData, 0, 0\n          canvas\n\n        ";
            return x;
          })(function() {
            var canvas, ctx, document, imageData;
            document = this.lib.window.document;
            imageData = this.imageData;
            canvas = document.createElement("canvas");
            canvas.height = imageData.height;
            canvas.width = imageData.width;
            ctx = canvas.getContext("2d");
            ctx.putImageData(imageData, 0, 0);
            return canvas;
          }),
          frames: [],
          addFrame: (function(x) {
            x.coffee = "@>\n            @frames.push @getAsCanvas()\n            @framesButtonClick()\n        ";
            return x;
          })(function() {
            this.frames.push(this.getAsCanvas());
            return this.framesButtonClick();
          }),
          framesButtonClick: (function(x) {
            x.coffee = "@>\n          { $ } = @lib\n          @setDialog \"frames\", ->\n              @label \"Frames: \"\n              @span class:\"framesList\"\n              @button onclick:\"javascript:spiritcase.addFrame()\", \"Add\"\n          $(\".framesList\").add @frames\n          @setupFrame k, v for k,v of @frames\n\n        ";
            return x;
          })(function() {
            var $, k, v, _ref, _results;
            $ = this.lib.$;
            this.setDialog("frames", function() {
              this.label("Frames: ");
              this.span({
                "class": "framesList"
              });
              return this.button({
                onclick: "javascript:spiritcase.addFrame()"
              }, "Add");
            });
            $(".framesList").add(this.frames);
            _ref = this.frames;
            _results = [];
            for (k in _ref) {
              v = _ref[k];
              _results.push(this.setupFrame(k, v));
            }
            return _results;
          }),
          swapFrame: (function(x) {
            x.coffee = "(event, el1, i)@>\n            @updateIcon()\n            event.stopPropagation()\n            event.preventDefault()\n            el0 = @icon.el\n            @icon.el = el1\n            @frames[i] = el0\n            n0 = el0.nextSibling\n            p0 = el0.parentNode\n            n1 = el1.nextSibling\n            p1 = el1.parentNode\n            p0.insertBefore(el1, n0)\n            p1.insertBefore(el0, n1)\n            @setupFrame i, el0\n            @imageData = el1.getContext('2d').getImageData(0, 0, el1.width, el1.height)\n            @redraw()\n        \n        ";
            return x;
          })(function(event, el1, i) {
            var el0, n0, n1, p0, p1;
            this.updateIcon();
            event.stopPropagation();
            event.preventDefault();
            el0 = this.icon.el;
            this.icon.el = el1;
            this.frames[i] = el0;
            n0 = el0.nextSibling;
            p0 = el0.parentNode;
            n1 = el1.nextSibling;
            p1 = el1.parentNode;
            p0.insertBefore(el1, n0);
            p1.insertBefore(el0, n1);
            this.setupFrame(i, el0);
            this.imageData = el1.getContext('2d').getImageData(0, 0, el1.width, el1.height);
            return this.redraw();
          }),
          setupFrame: (function(x) {
            x.coffee = "(k,v)@>\n            v.setAttribute \"onclick\", \"javascript:spiritcase.swapFrame(event,this,#{k})\"\n        \n    \n        \n      ";
            return x;
          })(function(k, v) {
            return v.setAttribute("onclick", "javascript:spiritcase.swapFrame(event,this," + k + ")");
          })
        });
        return spiritcase.setup();
      })();
</script><script type="text/javascript">(function () {
        document.body.appendChild((function() {
          return spiritcase.view.toolbar = htmlcup.captureFirstTag(function() {
            var style;
            style = "position:absolute;\ntop:0;\ncolor:yellow;\nwidth:100%;";
            return this.div({
              style: style
            }, {
              "class": "spiritcaseToolbar"
            }, function() {
              this.style(".spiritcaseToolbar {\n    opacity:0.50;\n}\n.spiritcaseToolbar label {\n  font-size: 125%;\n  color:white;\n}\n.spiritcaseToolbarGroup {\n  display:inline-block;\n  padding:0 1em;\n  vertical-align:text-top;\n}\nbutton.squarebutton {\n  width: 1.5em;\n  max-width: 1.5em;\n  text-align: center;\n}\n.spiritcaseToolbar:hover {\n    opacity:0.80;\n}\n#spiritcaseColorInput {\n  font-size:125%;\n  text-align:center;\n}\n.spiritcaseToolbar select, .spiritcaseToolbar button { font-size:inherit; text-align:center;   }\n.spiritcaseToolbar .button { display:inline-block; }\n.spiritcaseToolbar button, .spiritcaseToolbar .button,  .spiritcaseToolbar input, .spiritcaseToolbar select:not(:focus):not(:hover) {\n    color:white; background:black;\n}\n.spiritcaseToolbar button:hover, .spiritcaseToolbar .button:hover,  .spiritcaseToolbar input:hover, .spiritcaseToolbar select:hover {\n    color:black; background:white;\n}\n/* select option:not(:checked) { color:red !important; background:black !important; } */\n/* option:active, option[selected], option:checked, option:hover, option:focus { background:#248 !important; } */\n.spiritcaseToolbar button, .spiritcaseToolbar .button { min-width:5%; font-size:150%; border: 2px outset grey; }\n.spiritcaseToolbar button.activated:not(:hover), .spiritcaseToolbar button:active, .spiritcaseToolbar .button.button-on { border: 2px inset grey; background:#248; }\n.spiritcaseToolbar      .button input[type=\"checkbox\"] { display:none; }\n.spiritcaseToolbar .paletteEntry { cursor:pointer; }");
              return this.div({
                style: "text-align:center;width:100%"
              }, function() {
                this.div({
                  id: "spiritcaseToolbar",
                  style: "display:inline-block;text-align:initial"
                }, function() {
                  this.div({
                    "class": "spiritcaseToolbarGroup",
                    style: "font-size:initial;text-align:initial"
                  }, function() {
                    this.button({
                      id: "spiritcaseLoadButton",
                      onclick: "javascript:spiritcase.loadButtonClick(this)"
                    }, "Load");
                    this.button({
                      id: "spiritcaseSaveButton",
                      onclick: "javascript:spiritcase.saveButtonClick(this)"
                    }, "Save");
                    this.button({
                      id: "spiritcasePaintButton",
                      "class": "activated",
                      onclick: "javascript:spiritcase.paintButtonClick(this)"
                    }, "Paint");
                    this.button({
                      id: "spiritcaseEraseButton",
                      onclick: "javascript:spiritcase.eraseButtonClick(this)"
                    }, "Erase");
                    this.button({
                      id: "spiritcaseUndoButton",
                      onclick: "javascript:spiritcase.undoButtonClick(this)"
                    }, "Undo");
                    return this.button({
                      id: "spiritcaseFramesButton",
                      onclick: "javascript:spiritcase.framesButtonClick(this)"
                    }, "Frames");
                  });
                  this.div({
                    "class": "spiritcaseToolbarGroup",
                    style: "font-size:initial;text-align:initial"
                  }, function() {
                    return spiritcase.lib.sliderInput.build({
                      htmlcup: this,
                      label: "Zoom",
                      value: "" + spiritcase.factor,
                      width: "3em",
                      noBar: true,
                      buildModule: function(sliderInput) {
                        return spiritcase.makeWebmodule("sliderInputZoom", function() {
                          return {
                            spiritcase: this,
                            __proto__: sliderInput,
                            incButton: (function(x) {
                              x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.zoomIn()\n                                          @refresh(el)\n                                        ";
                              return x;
                            })(function(ev, el) {
                              this.terminateEvent(ev);
                              this.spiritcase.zoomIn();
                              return this.refresh(el);
                            }),
                            decButton: (function(x) {
                              x.coffee = "(ev,el)@>\n                                          @terminateEvent(ev)\n                                          @spiritcase.zoomOut()\n                                          @refresh(el)\n                                        ";
                              return x;
                            })(function(ev, el) {
                              this.terminateEvent(ev);
                              this.spiritcase.zoomOut();
                              return this.refresh(el);
                            }),
                            refresh: (function(x) {
                              x.coffee = "(el)@>\n                                          @setView el,\n                                            text: \"#{@spiritcase.factor}\"\n                                        ";
                              return x;
                            })(function(el) {
                              return this.setView(el, {
                                text: "" + this.spiritcase.factor
                              });
                            }),
                            $: this.lib.$
                          };
                        });
                      }
                    });
                  });
                  return this.div({
                    "class": "spiritcaseToolbarGroup"
                  }, function() {
                    return this.input({
                      id: "spiritcaseColorInput",
                      type: "text",
                      placeholder: "Color",
                      size: "7",
                      onfocus: "javascript:spiritcase.withColorinput(this).onfocus(event)",
                      oninput: "javascript:spiritcase.withColorinput(this).oninput(event)",
                      style: "background:" + (spiritcase.lib.color.rgb2hex(spiritcase.toolColor))
                    });
                  });
                });
                return this.div({
                  id: "spiritcaseDialogs"
                }, function() {});
              });
            });
          });
        })());
        return spiritcase.view.dialogs = document.getElementById('spiritcaseDialogs');
      })();
</script><script type="text/javascript">(function () {
        var setupDrop, spiritcase;
        window.setWindowEventListener = (function(listeners) {
          return function(name, cb, flag) {
            var old;
            if ((old = listeners[name]) != null) {
              window.removeEventListener(name, old);
            }
            return window.addEventListener(name, listeners[name] = cb, flag);
          };
        })({});
        spiritcase = window.spiritcase;
        if (File && FileList && FileReader && Blob) {
          setupDrop = function(element, withImageData) {
            var withDataUrl;
            withDataUrl = function(d) {
              var img, nextTick;
              img = document.createElement('img');
              img.src = d;
              nextTick = function(x) {
                return setTimeout(x, 0);
              };
              return nextTick(function() {
                var canvas, context;
                canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                context = canvas.getContext('2d');
                context.drawImage(img, 0, 0);
                return withImageData(context.getImageData(0, 0, canvas.width, canvas.height));
              });
            };
            setWindowEventListener("dragover", function(event) {
              event.stopPropagation();
              event.preventDefault();
              return event.dataTransfer.dropEffect = 'copy';
            });
            return setWindowEventListener("drop", function(event) {
              var file, _i, _len, _ref, _results;
              event.stopPropagation();
              event.preventDefault();
              _ref = event.dataTransfer.files;
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                file = _ref[_i];
                _results.push((function(file) {
                  var r;
                  r = new FileReader;
                  r.onload = function(event) {
                    return withDataUrl(event.target.result);
                  };
                  return r.readAsDataURL(file);
                })(file));
              }
              return _results;
            });
          };
          return setupDrop(window, function(imageData) {
            return spiritcase.load(imageData);
          });
        }
      })();
</script><script type="text/javascript">(function () {
        window.deleteNode = function(x) {
          return x.parentNode.removeChild(x);
        };
        window.assert = function(c, msg) {
          if (!c) {
            return alert(msg);
          }
        };
        return window.jsLoad = function(sym, src, callback) {
          var x, y;
          if ((!sym) || !(window[sym] != null)) {
            x = document.createElement('script');
            x.type = 'text/javascript';
            x.src = src;
            y = 1;
            x.onload = x.onreadystatechange = function() {
              if (sym) {
                assert(window[sym] != null, "Symbol " + sym + " was not defined after loading library");
              }
              if (y && !this.readyState || this.readyState === 'complete') {
                y = 0;
                deleteNode(x);
                if (callback) {
                  return callback();
                }
              }
            };
            return document.getElementsByTagName('head')[0].appendChild(x);
          }
        };
      })();
</script><script type="text/javascript">(function () {
        var coffeecharniaLayout, withAce, withCoffee;
        coffeecharniaLayout = function(_arg) {
          var body, footer, header, innerStyle, minheight, minwidth, style;
          header = _arg.header, body = _arg.body, footer = _arg.footer, minheight = _arg.minheight, minwidth = _arg.minwidth, style = _arg.style, innerStyle = _arg.innerStyle;
          return htmlcup.captureFirstTag(function() {
            return this.div({
              id: "coffeecharniaConsole",
              "class": "coffeecharniaContainer",
              style: "" + style
            }, function() {
              return this.div({
                style: "height:100%;display:table;width:100%;max-width:100%;table-layout:fixed"
              }, function() {
                if (innerStyle != null) {
                  this.style(innerStyle);
                }
                if (false) {
                  header.call(this, {
                    style: "display:table-row;min-height:1em;overflow:auto;max-height:5em",
                    "class": "consoleHeader"
                  });
                } else if (false) {
                  this.div({
                    style: "display:table-row;min-height:1em;background:pink"
                  }, function() {
                    return this.div({
                      style: "max-height:5em;overflow-y:scroll;overflow-x:hidden;position:relative;display:block"
                    }, function() {
                      return this.div({
                        style: "float:left;width:100%",
                        contentEditable: "true"
                      }, function() {
                        var x, _i, _results;
                        _results = [];
                        for (x = _i = 0; _i <= 25; x = ++_i) {
                          _results.push(this.div("x"));
                        }
                        return _results;
                      });
                    });
                  });
                } else {
                  this.div({
                    style: "display:table-row;min-height:1em"
                  }, function() {
                    return this.div({
                      style: "max-height:5em;overflow:hidden;position:relative;display:block"
                    }, function() {
                      return this.div({
                        style: "float:left;width:100%"
                      }, function() {
                        return header != null ? header.call(this, {
                          "class": "consoleHeader"
                        }) : void 0;
                      });
                    });
                  });
                }
                if (false) {
                  this.div({
                    style: "position:relative;height:100%;overflow:hidden;display:table-row"
                  }, function() {
                    return this.div({
                      style: "position:relative;width:100%;height:100%;min-height:" + minheight
                    }, function() {
                      return this.div({
                        style: "position:absolute;top:0;right:0;left:0;bottom:0;overflow:auto"
                      }, function() {
                        return this.div({
                          style: "width:200%;max-width:50em;min-width:100%;height:100%;overflow:hidden"
                        }, function() {
                          return this.div({
                            style: "position:relative;width:100%;height:100%;display:table"
                          }, function() {
                            return body.call(this);
                          });
                        });
                      });
                    });
                  });
                } else {
                  this.div({
                    style: "position:relative;height:100%;overflow:hidden;display:table-row"
                  }, function() {
                    return this.div({
                      style: "position:relative;width:100%;height:100%;min-height:" + minheight
                    }, function() {
                      return this.div({
                        style: "position:absolute;top:0;right:0;left:0;bottom:0;overflow:auto"
                      }, function() {
                        return body.call(this);
                      });
                    });
                  });
                }
                return footer.call(this, {
                  id: "footer",
                  style: "display:table-row"
                });
              });
            });
          });
        };
        (function(x) {
          return document.body.appendChild(coffeecharniaLayout(x));
        })({
          style: "position:absolute;overflow:auto;width:40%;height:25%;bottom:0;right:0;background:black;color:#ddd",
          innerStyle: "div,pre { padding: 0; margin:0; }\na { color: #ffb }\na:visited { color: #eec }\na:hover { color: white }",
          minheight: "7em",
          minwidth: "60em",
          head: function() {
            this.meta({
              charset: "utf-8"
            });
            return this.style("body { background:black; color: #ddd; }\na { color:#5af; }\na:visited { color:#49f; }\na:hover { color:#6cf; }\nselect, textarea { border: 1px solid #555; }");
          },
          header: function(opts) {
            this.style("div.thisHeader, .thisHeader div { text-align:center; }");
            return this.div(opts, function() {
              this.style(".coffeecharniaContainer select { min-width:5em; max-width:30%; width:18em; }\n.coffeecharniaContainer select, .coffeecharniaContainer button { font-size:inherit; text-align:center;   }\n.coffeecharniaContainer .button { display:inline-block; }\n.coffeecharniaContainer button, .coffeecharniaContainer .button, .coffeecharniaContainer input, .coffeecharniaContainer select:not(:focus):not(:hover) { color:white; background:black; }\n/* select option:not(:checked) { color:red !important; background:black !important; } */\n/* option:active, option[selected], option:checked, option:hover, option:focus { background:#248 !important; } */\n.coffeecharniaContainer button, .coffeecharniaContainer .button { min-width:5%; font-size:220%; border: 2px outset grey; }\n.coffeecharniaContainer button:active, .coffeecharniaContainer .button.button-on { border: 2px inset grey; background:#248; }\n.coffeecharniaContainer .button input[type=\"checkbox\"] { display:none; }\n.coffeecharniaContainer .arrow { font-weight:bold;  }\n.coffeecharniaContainer .editArea { height:100%;width:100%;box-sizing:border-box; }");
              if (false) {
                return this.div({
                  "class": "thisHeader"
                }, function() {
                  return this.div(function() {
                    this.span("CoffeeCharnia");
                    this.button({
                      id: "killButton"
                    }, "×");
                    return this.button({
                      id: "runButton"
                    }, "▶");
                  });
                  this.select({
                    disabled: "1"
                  }, function() {
                    this.option("HTML");
                    return this.option("PHP");
                  });
                  this.button({
                    id: "fromButton",
                    "class": "arrow"
                  }, "«");
                  this.label({
                    id: "autoButton",
                    "class": "button button-on"
                  }, function() {
                    this.input({
                      type: "checkbox",
                      checked: "1",
                      onchange: 'this.parentNode.setAttribute("class", "button button-" + (this.checked ? "on" : "off"))'
                    });
                    return this.span({
                      id: "autoButtonText"
                    }, "Auto");
                  });
                  this.button({
                    id: "toButton",
                    "class": "arrow"
                  }, "»");
                  return this.select({
                    disabled: "1"
                  }, function() {
                    this.option("CoffeeScript (htmlcup)");
                    return this.option("Reflective CoffeeScript (htmlcup)");
                  });
                });
              }
            });
          },
          body: function(opts) {
            this.style(".coffeecharniaContainer textarea { background: black; color: #ddd; }\n.coffeecharniaContainer button { opacity: 0.4; }\n.coffeecharniaContainer button:hover, .coffeecharniaContainer button:focus, .coffeecharniaContainer button:active { opacity: 1; }");
            return this.div({
              style: "position:absolute;top:0;right:0;left:0;bottom:0;overflow:hidden"
            }, function() {
              this.button({
                id: "runButton",
                style: "width:1.5em;right:0;top:45px;position:absolute;z-index:1000000"
              }, "▶");
              this.button({
                id: "killButton",
                style: "width:1.5em;right:0;top:0;position:absolute;z-index:1000000"
              }, "×");
              return this.textarea({
                id: "coffeeArea",
                "class": "editArea"
              }, "# Welcome to CoffeeCharnia!\n");
            });
          },
          footer: function(opts) {
            this.style(".coffeecharniaContainer div.thisFooter, .coffeecharniaContainer .thisFooter div { text-align:center; }");
            return this.div({
              "class": "thisFooter"
            }, opts, function() {
              this.style("#resultFooter {\n  /* overflow:auto; */\n  vertical-align: middle;\n}\n#resultDatum {\n  text-align:initial;\n  vertical-align:initial;\n  display:inline-block;\n}");
              this.div({
                id: "resultFooter",
                style: "display:none"
              }, function() {
                return this.div({
                  id: "resultDatum"
                }, function() {});
              });
              return this.div({
                id: "introFooter"
              }, function() {
                this.b("CoffeeCharnia");
                this.span(function() {
                  this.span(": ");
                  return this.i("A Reflective Coffescript Console/Editor!");
                });
                this.printHtml(" &bull; ");
                return this.a({
                  href: "https://github.com/rev22/reflective-coffeescript"
                }, "Reflective Coffeescript");
              });
            });
          }
        });
        withAce = function(cb) {
          return jsLoad('ace', "https://github.com/ajaxorg/ace-builds/raw/master/src-min-noconflict/ace.js", cb);
        };
        withCoffee = function(cb) {
          return jsLoad('CoffeeScript', "lib/coffee-script.js", cb);
        };
        return withAce(function() {
          return withCoffee(function() {
            var app, camelcapBookmarklet, globalLibs, inject;
            globalLibs = {
              aceRefcoffeeMode: {
                setup: (function(x) {
                  x.coffee = "({ace, console, CoffeeScript})@>\n                  ace.define \"ace/mode/refcoffee_highlight_rules\", [\n                    \"require\"\n                    \"exports\"\n                    \"module\"\n                    \"ace/mode/coffee_highlight_rules\"\n                  ], (req, exports, module)->\n                    RefcoffeeHighlightRules = ->\n                      @$rules.start = [\n                          {\n                            stateName: \"litdoc\"\n                            token: \"string\"\n                            regex: \"''''\"\n                          }\n                      ].concat @$rules.start\n\n                      @$rules.start = for x in @$rules.start\n                        if x?.regex? and typeof x.regex is 'string'\n                          x.regex = x.regex.replace /\\[\\\\-=\\]>/, \"[\\\\-=@]>\"\n                        x\n                      \n                      @normalizeRules()\n                      return\n                    \"use strict\"\n                    makeClass = (p)-> c = p.constructor; c:: = p; c\n                    CoffeeHighlightRules = req(\"./coffee_highlight_rules\").CoffeeHighlightRules\n                    exports.RefcoffeeHighlightRules = makeClass\n                      constructor: ->\n                        CoffeeHighlightRules.call @\n                        RefcoffeeHighlightRules.call @\n                        return\n                      __proto__: CoffeeHighlightRules::\n                    return\n                    \n                  ace.define \"ace/mode/refcoffee\", [\n                    \"require\"\n                    \"exports\"\n                    \"module\"\n                    \"ace/mode/coffee\"\n                    \"ace/mode/refcoffee_highlight_rules\"\n                  ], (req, exports, module)->\n                    WorkerClient = undefined\n                    CoffeeMode = req(\"ace/mode/coffee\").Mode\n                    makeClass = (p)-> c = p.constructor; c:: = p; c\n                    Rules = req(\"./refcoffee_highlight_rules\").RefcoffeeHighlightRules\n                    Mode = makeClass\n                      __proto__: CoffeeMode::\n                      constructor: ->\n                        CoffeeMode.call @\n                        @HighlightRules = Rules\n                        # @$outdent = new Outdent()\n                        # @foldingRules = new FoldMode()\n                        return\n                    \"use strict\"\n                    (->\n                      @$id = \"ace/mode/refcoffee\"\n                      @createWorker = (session)-> null\n                      return\n                    ).call Mode::\n                    exports.Mode = Mode\n                    return\n\n        ";
                  return x;
                })(function(_arg) {
                  var CoffeeScript, ace, console;
                  ace = _arg.ace, console = _arg.console, CoffeeScript = _arg.CoffeeScript;
                  ace.define("ace/mode/refcoffee_highlight_rules", ["require", "exports", "module", "ace/mode/coffee_highlight_rules"], function(req, exports, module) {
                    var CoffeeHighlightRules, RefcoffeeHighlightRules, makeClass;
                    RefcoffeeHighlightRules = function() {
                      var x;
                      this.$rules.start = [
                        {
                          stateName: "litdoc",
                          token: "string",
                          regex: "''''"
                        }
                      ].concat(this.$rules.start);
                      this.$rules.start = (function() {
                        var _i, _len, _ref, _results;
                        _ref = this.$rules.start;
                        _results = [];
                        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                          x = _ref[_i];
                          if (((x != null ? x.regex : void 0) != null) && typeof x.regex === 'string') {
                            x.regex = x.regex.replace(/\[\\-=\]>/, "[\\-=@]>");
                          }
                          _results.push(x);
                        }
                        return _results;
                      }).call(this);
                      this.normalizeRules();
                    };
                    "use strict";
                    makeClass = function(p) {
                      var c;
                      c = p.constructor;
                      c.prototype = p;
                      return c;
                    };
                    CoffeeHighlightRules = req("./coffee_highlight_rules").CoffeeHighlightRules;
                    exports.RefcoffeeHighlightRules = makeClass({
                      constructor: function() {
                        CoffeeHighlightRules.call(this);
                        RefcoffeeHighlightRules.call(this);
                      },
                      __proto__: CoffeeHighlightRules.prototype
                    });
                  });
                  return ace.define("ace/mode/refcoffee", ["require", "exports", "module", "ace/mode/coffee", "ace/mode/refcoffee_highlight_rules"], function(req, exports, module) {
                    var CoffeeMode, Mode, Rules, WorkerClient, makeClass;
                    WorkerClient = void 0;
                    CoffeeMode = req("ace/mode/coffee").Mode;
                    makeClass = function(p) {
                      var c;
                      c = p.constructor;
                      c.prototype = p;
                      return c;
                    };
                    Rules = req("./refcoffee_highlight_rules").RefcoffeeHighlightRules;
                    Mode = makeClass({
                      __proto__: CoffeeMode.prototype,
                      constructor: function() {
                        CoffeeMode.call(this);
                        this.HighlightRules = Rules;
                      }
                    });
                    "use strict";
                    (function() {
                      this.$id = "ace/mode/refcoffee";
                      this.createWorker = function(session) {
                        return null;
                      };
                    }).call(Mode.prototype);
                    exports.Mode = Mode;
                  });
                })
              }
            };
            window.DynmodPrinter = {
              pkgInfo: {
                version: "DynmodPrinter 0.2.7-coffeecharnia",
                description: "Generic printer, for data and reflective code",
                copyright: "Copyright (c) 2014 Michele Bini",
                license: "MIT"
              },
              pkgTest: (function(x) {
                x.coffee = "@>\n            testPrint = (v, r)=>\n              r2 = @print(v)\n              if r isnt r2\n                throw \"Expected representation: '#{r}', obtained: '#{r2}'\"\n            testPrint [ ], \"[ ]\"\n            testPrint [ { } ], \"[ { } ]\"\n            testPrint new @Date(\"2014-05-12T23:04:24.627Z\"), 'new Date(\"2014-05-12T23:04:24.627Z\")'\n          ";
                return x;
              })(function() {
                var testPrint;
                testPrint = (function(_this) {
                  return function(v, r) {
                    var r2;
                    r2 = _this.print(v);
                    if (r !== r2) {
                      throw "Expected representation: '" + r + "', obtained: '" + r2 + "'";
                    }
                  };
                })(this);
                testPrint([], "[ ]");
                testPrint([{}], "[ { } ]");
                return testPrint(new this.Date("2014-05-12T23:04:24.627Z"), 'new Date("2014-05-12T23:04:24.627Z")');
              }),
              Date: Date,
              Array: Array,
              RegExp: RegExp,
              columns: 74,
              console: console,
              window: window,
              global: window,
              globalName: "window",
              symbolicPackages: true,
              newline: (function(x) {
                x.coffee = "@> true";
                return x;
              })(function() {
                return true;
              }),
              limitLines: (function(x) {
                x.coffee = "(maxLines)@>\n            lines: 0\n            maxLines: maxLines\n            newline: @> @lines++ < @maxLines\n            __proto__: @\n          ";
                return x;
              })(function(maxLines) {
                return {
                  lines: 0,
                  maxLines: maxLines,
                  newline: (function(x) {
                    x.coffee = "@> @lines++ < @maxLines";
                    return x;
                  })(function() {
                    return this.lines++ < this.maxLines;
                  }),
                  __proto__: this
                };
              }),
              print: (function(x) {
                x.coffee = "(x, prev, depth = 0, ind = \"\")@>\n              p = arguments.callee\n              depth = depth + 1\n              print = (y)=> p.call @, y, { prev, x }, depth\n              clean = (x)->\n                if /^[(]([(@][^\\n]*)[)]$/.test x\n                  x.substring(1, x.length - 1)\n                else\n                  x\n              if x == null\n                ind + \"null\"\n              else if x == @global\n                ind + @globalName\n              else if x == undefined\n                ind + \"undefined\"\n              else\n                t = typeof x\n                if t is \"boolean\"\n                  ind + if x then \"true\" else \"false\"\n                else if t is \"number\"\n                  ind + @printNumber x\n                else if t is \"string\"\n                  if x.length > 8 and /\\n/.test x\n                    l = x.split(\"\\n\")\n                    l = (x.replace /\\\"\\\"\\\"/g, '\\\"\\\"\\\"' for x in l)\n                    l.unshift ind + '\"\"\"'\n                    l.push     ind + '\"\"\"'\n                    l.join(ind + \"\\n\")\n                  else\n                    ind + '\"' + x.replace(/\\\"/g, \"\\\\\\\"\") + '\"'\n                else if t is \"function\"\n                  ni = ind + \"  \"\n                  if x.coffee?\n                    # YAY a reflective function!!!\n                    s = x.coffee\n                    if depth is 1 or /\\n/.test s\n                      lines = s.split \"\\n\"\n                      if lines.length > 1\n                        if (mn = lines[1].match(/^[ \\t]+/))?\n                          mn = mn[0].length\n                          id = mn - ni.length\n                          if id > 0\n                            x = new @RegExp(\"[ \\\\t]{#{id}}\")\n                            lines = (line.replace x, \"\" for line in lines)\n                          else if id < 0\n                            ni = @Array(-id + 1).join(\" \")\n                            lines = (ni + line for line in lines)                \n                      lines.join(\"\\n\")\n                    else\n                      ind + \"(\" + s + \")\"\n                  else\n                    ind + x.toString().replace(/\\n/g, '\\n' + ni)\n                else if (c = (do (p = prev, c = 1)-> (return c if p.x == x; p = p.prev; c++) while p?; 0))\n                  # Report cyclic structures\n                  \"<cycle-#{c}+#{depth - c - 1}>\"\n                else if t isnt \"object\"\n                  # print object of odd type\n                  \"<#{t}>\"\n                else if @Array.isArray x\n                  if x.length is 0\n                    \"[ ]\"\n                  else\n                    cl = 2\n                    hasLines = false\n                    xxxx = for xx in x\n                      break unless @newline()\n                      xx = print xx\n                      hasLines = true if /\\n/.test xx\n                      cl += 2 + xx.length\n                      xx\n                    if not hasLines and depth * 2 + cl + 1 < @columns\n                      \"[ \" + xxxx.join(\", \") + \" ]\"\n                    else\n                      ni = ind + \"  \"\n                      l = [ ind + \"[\" ]\n                      for xx in xxxx\n                        l.push ni + clean(xx).replace(/\\n/g, '\\n' + ni)\n                      l.push ind + \"]\"\n                      l.join \"\\n\"\n                else\n                  l = [ ]\n                  @window?.document?   and   x.id?   and   typeof x.id is \"string\"   and   x is @window.document.getElementById x.id   then\n                    return \"#{ind}window.document.getElementById '#{ x.id.replace(/\\'/, \"\\\\'\") }'\"\n                  @symbolicPackages and depth > 1 and (packageVersion = x.pkgInfo?.version)? then\n                    return ind + \"dynmodArchive.load '\" + packageVersion.replace(/\\ .*/, \"\") + \"'\"\n                  ind = \"\"\n                  if x instanceof @Date\n                    return \"new Date(\\\"#{x.toISOString()}\\\")\"\n                  keys = (k for k of x)\n                  if keys.length is 0\n                    return \"{ }\"\n                  unless (!prev? or typeof prev.x is \"object\" and !@Array.isArray prev.x)\n                    l = [ \"do->\" ]\n                    ind = \"  \"\n                  ni = ind + \"  \"\n                  # keys = (h)@> (x for x of h).sort()\n                  for k in keys\n                    break unless @newline()\n                    v = x[k]\n                    if @global[k] is v\n                      # l.push ind + k + \": eval \" + \"'\" + k + \"'\"\n                      l.push \"#{ind}#{k}: #{@globalName}.#{k}\"\n                    else\n                      v = clean(print v).replace(/\\n/g, '\\n' + ni)\n                      if !/\\n/.test(v) and  ind.length + k.toString().length + 2 + v.length < @columns\n                        l.push ind + k + \": \" + v\n                      else\n                        l.push ind + k + \":\"\n                        l.push ni + v\n                  if l.length\n                    l.join \"\\n\"\n                  else\n                    \"{ }\"\n          ";
                return x;
              })(function(x, prev, depth, ind) {
                var c, cl, clean, hasLines, id, k, keys, l, line, lines, mn, ni, p, packageVersion, print, s, t, v, xx, xxxx, _i, _j, _len, _len1, _ref, _ref1;
                if (depth == null) {
                  depth = 0;
                }
                if (ind == null) {
                  ind = "";
                }
                p = arguments.callee;
                depth = depth + 1;
                print = (function(_this) {
                  return function(y) {
                    return p.call(_this, y, {
                      prev: prev,
                      x: x
                    }, depth);
                  };
                })(this);
                clean = function(x) {
                  if (/^[(]([(@][^\n]*)[)]$/.test(x)) {
                    return x.substring(1, x.length - 1);
                  } else {
                    return x;
                  }
                };
                if (x === null) {
                  return ind + "null";
                } else if (x === this.global) {
                  return ind + this.globalName;
                } else if (x === void 0) {
                  return ind + "undefined";
                } else {
                  t = typeof x;
                  if (t === "boolean") {
                    return ind + (x ? "true" : "false");
                  } else if (t === "number") {
                    return ind + this.printNumber(x);
                  } else if (t === "string") {
                    if (x.length > 8 && /\n/.test(x)) {
                      l = x.split("\n");
                      l = (function() {
                        var _i, _len, _results;
                        _results = [];
                        for (_i = 0, _len = l.length; _i < _len; _i++) {
                          x = l[_i];
                          _results.push(x.replace(/\"\"\"/g, '\"\"\"'));
                        }
                        return _results;
                      })();
                      l.unshift(ind + '"""');
                      l.push(ind + '"""');
                      return l.join(ind + "\n");
                    } else {
                      return ind + '"' + x.replace(/\"/g, "\\\"") + '"';
                    }
                  } else if (t === "function") {
                    ni = ind + "  ";
                    if (x.coffee != null) {
                      s = x.coffee;
                      if (depth === 1 || /\n/.test(s)) {
                        lines = s.split("\n");
                        if (lines.length > 1) {
                          if ((mn = lines[1].match(/^[ \t]+/)) != null) {
                            mn = mn[0].length;
                            id = mn - ni.length;
                            if (id > 0) {
                              x = new this.RegExp("[ \\t]{" + id + "}");
                              lines = (function() {
                                var _i, _len, _results;
                                _results = [];
                                for (_i = 0, _len = lines.length; _i < _len; _i++) {
                                  line = lines[_i];
                                  _results.push(line.replace(x, ""));
                                }
                                return _results;
                              })();
                            } else if (id < 0) {
                              ni = this.Array(-id + 1).join(" ");
                              lines = (function() {
                                var _i, _len, _results;
                                _results = [];
                                for (_i = 0, _len = lines.length; _i < _len; _i++) {
                                  line = lines[_i];
                                  _results.push(ni + line);
                                }
                                return _results;
                              })();
                            }
                          }
                        }
                        return lines.join("\n");
                      } else {
                        return ind + "(" + s + ")";
                      }
                    } else {
                      return ind + x.toString().replace(/\n/g, '\n' + ni);
                    }
                  } else if ((c = (function(p, c) {
                    while (p != null) {
                      if (p.x === x) {
                        return c;
                      }
                      p = p.prev;
                      c++;
                    }
                    return 0;
                  })(prev, 1))) {
                    return "<cycle-" + c + "+" + (depth - c - 1) + ">";
                  } else if (t !== "object") {
                    return "<" + t + ">";
                  } else if (this.Array.isArray(x)) {
                    if (x.length === 0) {
                      return "[ ]";
                    } else {
                      cl = 2;
                      hasLines = false;
                      xxxx = (function() {
                        var _i, _len, _results;
                        _results = [];
                        for (_i = 0, _len = x.length; _i < _len; _i++) {
                          xx = x[_i];
                          if (!this.newline()) {
                            break;
                          }
                          xx = print(xx);
                          if (/\n/.test(xx)) {
                            hasLines = true;
                          }
                          cl += 2 + xx.length;
                          _results.push(xx);
                        }
                        return _results;
                      }).call(this);
                      if (!hasLines && depth * 2 + cl + 1 < this.columns) {
                        return "[ " + xxxx.join(", ") + " ]";
                      } else {
                        ni = ind + "  ";
                        l = [ind + "["];
                        for (_i = 0, _len = xxxx.length; _i < _len; _i++) {
                          xx = xxxx[_i];
                          l.push(ni + clean(xx).replace(/\n/g, '\n' + ni));
                        }
                        l.push(ind + "]");
                        return l.join("\n");
                      }
                    }
                  } else {
                    l = [];
                    if ((((_ref = this.window) != null ? _ref.document : void 0) != null) && (x.id != null) && typeof x.id === "string" && x === this.window.document.getElementById(x.id)) {
                      return "" + ind + "window.document.getElementById '" + (x.id.replace(/\'/, "\\'")) + "'";
                    }
                    if (this.symbolicPackages && depth > 1 && ((packageVersion = (_ref1 = x.pkgInfo) != null ? _ref1.version : void 0) != null)) {
                      return ind + "dynmodArchive.load '" + packageVersion.replace(/\ .*/, "") + "'";
                    }
                    ind = "";
                    if (x instanceof this.Date) {
                      return "new Date(\"" + (x.toISOString()) + "\")";
                    }
                    keys = (function() {
                      var _results;
                      _results = [];
                      for (k in x) {
                        _results.push(k);
                      }
                      return _results;
                    })();
                    if (keys.length === 0) {
                      return "{ }";
                    }
                    if (!((prev == null) || typeof prev.x === "object" && !this.Array.isArray(prev.x))) {
                      l = ["do->"];
                      ind = "  ";
                    }
                    ni = ind + "  ";
                    for (_j = 0, _len1 = keys.length; _j < _len1; _j++) {
                      k = keys[_j];
                      if (!this.newline()) {
                        break;
                      }
                      v = x[k];
                      if (this.global[k] === v) {
                        l.push("" + ind + k + ": " + this.globalName + "." + k);
                      } else {
                        v = clean(print(v)).replace(/\n/g, '\n' + ni);
                        if (!/\n/.test(v) && ind.length + k.toString().length + 2 + v.length < this.columns) {
                          l.push(ind + k + ": " + v);
                        } else {
                          l.push(ind + k + ":");
                          l.push(ni + v);
                        }
                      }
                    }
                    if (l.length) {
                      return l.join("\n");
                    } else {
                      return "{ }";
                    }
                  }
                }
              }),
              printNumber: (function(x) {
                x.coffee = "(x)@> \"#{x}\"";
                return x;
              })(function(x) {
                return "" + x;
              })
            };
            window.coffeecharnia = app = {
              libs: {
                CoffeeScript: window.CoffeeScript,
                aceRefcoffeeMode: globalLibs.aceRefcoffeeMode,
                ace: window.ace,
                DynmodPrinter: DynmodPrinter
              },
              "eval": window["eval"],
              setTimeout: window.setTimeout,
              getInputSelection: window.getInputSelection,
              global: window["eval"]('window'),
              window: window,
              view: (function(x) {
                var r, v, _i, _len, _ref;
                r = {};
                _ref = x.split(",");
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  v = _ref[_i];
                  r[v] = document.getElementById(v);
                }
                return r;
              })("coffeeArea,runButton,killButton,introFooter,resultFooter,resultDatum,coffeecharniaConsole"),
              accumulator: [],
              printHtml: (function(x) {
                x.coffee = "(s)@>\n            @accumulator.push s\n\n          ";
                return x;
              })(function(s) {
                return this.accumulator.push(s);
              }),
              isConverting: false,
              processSource: (function(x) {
                x.coffee = "(s)@> \"((x)->x.call(spiritcase)) ()->\" + (\"\\n\" + s).replace(/\\n/g, \"\\n  \")";
                return x;
              })(function(s) {
                return "((x)->x.call(spiritcase)) ()->" + ("\n" + s).replace(/\n/g, "\n  ");
              }),
              evalCoffeescript: (function(x) {
                x.coffee = "(x)@>\n            @eval(@libs.CoffeeScript.compile(@processSource(x), bare:true))\n\n          ";
                return x;
              })(function(x) {
                return this["eval"](this.libs.CoffeeScript.compile(this.processSource(x), {
                  bare: true
                }));
              }),
              evalWithSourceMap: (function(x) {
                x.coffee = "(x)@>\n            # This technique does not seem to work properly on Chromium 22\n            { js, sourceMapV3, file_name } = @libs.CoffeeScript.compile x, sourceMap: 1\n            @lastSourceMap = \"\"\n            @eval(js)\n\n          ";
                return x;
              })(function(x) {
                var file_name, js, sourceMapV3, _ref;
                _ref = this.libs.CoffeeScript.compile(x, {
                  sourceMap: 1
                }), js = _ref.js, sourceMapV3 = _ref.sourceMapV3, file_name = _ref.file_name;
                this.lastSourceMap = "";
                return this["eval"](js);
              }),
              preQuote: (function(x) {
                x.coffee = "(x)@> \"<pre>#{ x.replace /</g, \"&lt;\" }</pre>\"";
                return x;
              })(function(x) {
                return "<pre>" + (x.replace(/</g, "&lt;")) + "</pre>";
              }),
              printVal: (function(x) {
                x.coffee = "(x)@>\n            @preQuote(@libs.DynmodPrinter.limitLines(1000).print(x))\n            # x.toString()\n\n          ";
                return x;
              })(function(x) {
                return this.preQuote(this.libs.DynmodPrinter.limitLines(1000).print(x));
              }),
              recalculateTextareaSize: (function(x) {
                x.coffee = "@>\n            { setTimeout } = @\n            setTimeout (=>\n              editor = @view.coffeeArea.transformed\n              editor.resize()\n              editor.renderer.scrollCursorIntoView()\n            ), 0\n          \n          ";
                return x;
              })(function() {
                var setTimeout;
                setTimeout = this.setTimeout;
                return setTimeout(((function(_this) {
                  return function() {
                    var editor;
                    editor = _this.view.coffeeArea.transformed;
                    editor.resize();
                    return editor.renderer.scrollCursorIntoView();
                  };
                })(this)), 0);
              }),
              runButtonClick: (function(x) {
                x.coffee = "@>\n            x = @view.coffeeArea.value\n            isError = null\n            val = if true\n              @evalCoffeescript x catch error\n                isError = true\n                val = error.stack ? error?.toString() ? error ? \"Undefined error\"\n            else\n              @evalWithSourceMap x\n            { coffeecharniaConsole: console, introFooter, resultFooter, resultDatum } = @view\n            if val?\n              introFooter.setAttribute \"style\", \"display:none\"\n              # resultFooter.setAttribute \"style\", \"max-height:#{console.getBoundingClientRect().height / 2.6 | 0}px\"\n              resultFooter.setAttribute \"style\", \"\"\n              if isError\n                resultDatum.innerHTML = @preQuote val\n              else\n                resultDatum.innerHTML = @printVal val              \n            else\n              introFooter.setAttribute \"style\", \"\"\n              resultFooter.setAttribute \"style\", \"display:none\"\n              resultDatum.innerHTML = \"\"\n            (@aceEditor())? then\n              @recalculateTextareaSize()\n            else\n              { setTimeout } = @\n              if true\n                # Keep it Simple!\n                setTimeout (=> @view.coffeeArea.scrollTop += 999999), 0\n                return \n              fixUp = =>\n                area = @view.coffeeArea\n                area.focus()\n                (pos = area.selectionEnd)? then\n                  pos--\n                  area.setSelectionRange?(pos, pos)\n              setTimeout fixUp, 0\n          ";
                return x;
              })(function() {
                var console, error, fixUp, introFooter, isError, resultDatum, resultFooter, setTimeout, val, x, _ref;
                x = this.view.coffeeArea.value;
                isError = null;
                val = (function() {
                  var _ref, _ref1, _ref2;
                  if (true) {
                    try {
                      return this.evalCoffeescript(x);
                    } catch (_error) {
                      error = _error;
                      isError = true;
                      return val = (_ref = (_ref1 = (_ref2 = error.stack) != null ? _ref2 : error != null ? error.toString() : void 0) != null ? _ref1 : error) != null ? _ref : "Undefined error";
                    }
                  } else {
                    return this.evalWithSourceMap(x);
                  }
                }).call(this);
                _ref = this.view, console = _ref.coffeecharniaConsole, introFooter = _ref.introFooter, resultFooter = _ref.resultFooter, resultDatum = _ref.resultDatum;
                if (val != null) {
                  introFooter.setAttribute("style", "display:none");
                  resultFooter.setAttribute("style", "");
                  if (isError) {
                    resultDatum.innerHTML = this.preQuote(val);
                  } else {
                    resultDatum.innerHTML = this.printVal(val);
                  }
                } else {
                  introFooter.setAttribute("style", "");
                  resultFooter.setAttribute("style", "display:none");
                  resultDatum.innerHTML = "";
                }
                if ((this.aceEditor()) != null) {
                  return this.recalculateTextareaSize();
                } else {
                  setTimeout = this.setTimeout;
                  if (true) {
                    setTimeout(((function(_this) {
                      return function() {
                        return _this.view.coffeeArea.scrollTop += 999999;
                      };
                    })(this)), 0);
                    return;
                  }
                  fixUp = (function(_this) {
                    return function() {
                      var area, pos;
                      area = _this.view.coffeeArea;
                      area.focus();
                      if ((pos = area.selectionEnd) != null) {
                        pos--;
                        return typeof area.setSelectionRange === "function" ? area.setSelectionRange(pos, pos) : void 0;
                      }
                    };
                  })(this);
                  return setTimeout(fixUp, 0);
                }
              }),
              setup: (function(x) {
                x.coffee = "@>\n            # @fs.readFileSync = (x)=> @readFileSync(x)\n            # @fs.writeFileSync = (x)=> @readFileSync(x)\n            # @ace? and @setupAce()\n            app = @\n            @view.runButton.onclick = => @runButtonClick()\n            @view.killButton.onclick = => @killButtonClick()\n            area = @view.coffeeArea\n            area.focus()\n            (pos = area.value.length)? then area.setSelectionRange?(pos, pos)\n            area.setupTransform = (editor)->\n              area.transformed = editor\n              app.aceRefcoffeeMode (mode)->\n                editor.getSession().setMode(mode)\n              editor.setTheme(\"ace/theme/merbivore\")\n            window.onkeydown = (event)->\n              return app.handleEnterKey?(event) if event.keyCode and event.keyCode is 13\n              true\n\n          ";
                return x;
              })(function() {
                var app, area, pos;
                app = this;
                this.view.runButton.onclick = (function(_this) {
                  return function() {
                    return _this.runButtonClick();
                  };
                })(this);
                this.view.killButton.onclick = (function(_this) {
                  return function() {
                    return _this.killButtonClick();
                  };
                })(this);
                area = this.view.coffeeArea;
                area.focus();
                if ((pos = area.value.length) != null) {
                  if (typeof area.setSelectionRange === "function") {
                    area.setSelectionRange(pos, pos);
                  }
                }
                area.setupTransform = function(editor) {
                  area.transformed = editor;
                  app.aceRefcoffeeMode(function(mode) {
                    return editor.getSession().setMode(mode);
                  });
                  return editor.setTheme("ace/theme/merbivore");
                };
                return window.onkeydown = function(event) {
                  if (event.keyCode && event.keyCode === 13) {
                    return typeof app.handleEnterKey === "function" ? app.handleEnterKey(event) : void 0;
                  }
                  return true;
                };
              }),
              getElement: (function(x) {
                x.coffee = "@> @view.coffeecharniaConsole";
                return x;
              })(function() {
                return this.view.coffeecharniaConsole;
              }),
              killButtonClick: (function(x) {
                x.coffee = "@> el = @getElement(); el.setAttribute \"style\", el.getAttribute(\"style\") + \";display:none\"";
                return x;
              })(function() {
                var el;
                el = this.getElement();
                return el.setAttribute("style", el.getAttribute("style") + ";display:none");
              }),
              getSelection: (function(x) {
                x.coffee = "@>\n            (t = @view.coffeeArea.transformed)? then\n              t.getSelection()\n            else\n              @getInputSelection(@view)\n\n          ";
                return x;
              })(function() {
                var t;
                if ((t = this.view.coffeeArea.transformed) != null) {
                  return t.getSelection();
                } else {
                  return this.getInputSelection(this.view);
                }
              }),
              aceEditor: (function(x) {
                x.coffee = "@>\n            @view.coffeeArea.transformed\n    \n          ";
                return x;
              })(function() {
                return this.view.coffeeArea.transformed;
              }),
              handleEnterKey: (function(x) {
                x.coffee = "(event)@>\n            app.captured = event\n            if event.shiftKey\n              return true\n            if event.ctrlKey\n                  @runButtonClick()\n                  return false\n            (editor = @aceEditor())? then\n              alert = @alert\n              cursorPosition = editor.getCursorPosition()\n              doc = editor.session.doc\n              lines = doc.getLength()\n              # lines - 1 <= cursorPosition.row then\n              line = doc.getLine(cursorPosition.row)\n              !/\\S/.test(line) then\n                      line.length is cursorPosition.column then\n                          @runButtonClick()\n                          return false\n            else\n              area = @view.coffeeArea\n              (end = area.selectionEnd)? then\n                text = area.value\n                text.length > 0 and text.length <= end and text[text.length - 1] is \"\\n\" then\n                    @runButtonClick()\n                    return false\n            true\n\n          ";
                return x;
              })(function(event) {
                var alert, area, cursorPosition, doc, editor, end, line, lines, text;
                app.captured = event;
                if (event.shiftKey) {
                  return true;
                }
                if (event.ctrlKey) {
                  this.runButtonClick();
                  return false;
                }
                if ((editor = this.aceEditor()) != null) {
                  alert = this.alert;
                  cursorPosition = editor.getCursorPosition();
                  doc = editor.session.doc;
                  lines = doc.getLength();
                  line = doc.getLine(cursorPosition.row);
                  if (!/\S/.test(line)) {
                    if (line.length === cursorPosition.column) {
                      this.runButtonClick();
                      return false;
                    }
                  }
                } else {
                  area = this.view.coffeeArea;
                  if ((end = area.selectionEnd) != null) {
                    text = area.value;
                    if (text.length > 0 && text.length <= end && text[text.length - 1] === "\n") {
                      this.runButtonClick();
                      return false;
                    }
                  }
                }
                return true;
              }),
              aceRefcoffeeMode: (function(x) {
                x.coffee = "(cb)@>\n            cb? then\n              ace = @libs.ace\n              ace.config.loadModule \"ace/mode/coffee\", =>\n                @libs.aceRefcoffeeMode.setup ace: @libs.ace, CoffeeScript: @libs.CoffeeScript\n                cb \"ace/mode/refcoffee\"\n            else\n              try\n                @libs.aceRefcoffeeMode.setup ace: @libs.ace, CoffeeScript: @libs.CoffeeScript\n                @libs.ace.require(\"ace/mode/refcoffee\")\n                \"ace/mode/refcoffee\"\n              catch e\n                \"ace/mode/coffee\"\n\n          # ace: ace ? null\n          # setupAce: @> @ace.edit(@view.coffeeArea)\n\n          ";
                return x;
              })(function(cb) {
                var ace, e;
                if (cb != null) {
                  ace = this.libs.ace;
                  return ace.config.loadModule("ace/mode/coffee", (function(_this) {
                    return function() {
                      _this.libs.aceRefcoffeeMode.setup({
                        ace: _this.libs.ace,
                        CoffeeScript: _this.libs.CoffeeScript
                      });
                      return cb("ace/mode/refcoffee");
                    };
                  })(this));
                } else {
                  try {
                    this.libs.aceRefcoffeeMode.setup({
                      ace: this.libs.ace,
                      CoffeeScript: this.libs.CoffeeScript
                    });
                    this.libs.ace.require("ace/mode/refcoffee");
                    return "ace/mode/refcoffee";
                  } catch (_error) {
                    e = _error;
                    return "ace/mode/coffee";
                  }
                }
              }),
              Error: Error,
              files: {}
            };
            app.setup();
            if (false) {
              if (typeof ace !== "undefined" && ace !== null) {
                ace.options = {
                  mode: "coffee",
                  theme: "cobalt",
                  gutter: "true"
                };
              }
            }
            inject = function(options, callback) {
              var baseUrl, load;
              baseUrl = options.baseUrl || "../../src-noconflict";
              load = function(path, callback) {
                var head, s;
                head = document.getElementsByTagName("head")[0];
                s = document.createElement("script");
                s.src = baseUrl + "/" + path;
                head.appendChild(s);
                s.onload = s.onreadystatechange = function(_, isAbort) {
                  if (isAbort || !s.readyState || s.readyState === "loaded" || s.readyState === "complete") {
                    s = s.onload = s.onreadystatechange = null;
                    if (!isAbort) {
                      callback();
                    }
                  }
                };
              };
              if (typeof ace !== "undefined" && ace !== null) {
                ace.config.loadModule("ace/ext/textarea", function() {
                  var areas, event, i;
                  if (false) {
                    event = ace.require("ace/lib/event");
                    areas = document.getElementsByTagName("textarea");
                    i = 0;
                    while (i < areas.length) {
                      event.addListener(areas[i], "click", function(e) {
                        if (e.detail === 3) {
                          ace.transformTextarea(e.target, options.ace);
                        }
                      });
                      i++;
                    }
                  }
                  callback && callback();
                });
              }
            };
            camelcapBookmarklet = function(ace) {
              if (document.getElementById("ccapcss")) {
                return;
              }
              return ace.require(["ace/layer/text"], function(_arg) {
                var Text, orig, patched, x;
                Text = _arg.Text;
                if (document.getElementById("ccapcss")) {
                  return;
                }
                orig = Text.prototype.$renderToken;
                patched = (function(rgx) {
                  return function(builder, col, token, value) {
                    var match, p, q, s, type, type_c;
                    if (match = rgx.exec(value)) {
                      type = token.type;
                      type_c = type + ".ccap";
                      p = 0;
                      while (true) {
                        q = rgx.lastIndex - 1;
                        s = value.substring(p, q);
                        col = orig.call(this, builder, col, {
                          type: type,
                          value: s
                        }, s);
                        s = value.substring(q, p = q + 1);
                        col = orig.call(this, builder, col, {
                          type: type_c,
                          value: s
                        }, s);
                        if (!(match = rgx.exec(value))) {
                          break;
                        }
                      }
                      s = value.substring(p);
                      return orig.call(this, builder, col, {
                        type: type,
                        value: s
                      }, s);
                    } else {
                      return orig.apply(this, arguments);
                    }
                  };
                })(new RegExp("[a-z][0-9]*[A-Z]", "g"));
                Text.prototype.$renderToken = patched;
                x = document.createElement("style");
                x.id = "ccapcss";
                x.innerHTML = ".ace_ccap { font-weight: bold; }";
                return document.head.appendChild(x);
              });
            };
            if (typeof ace !== "undefined" && ace !== null) {
              camelcapBookmarklet(ace);
            }
            return inject({}, function() {
              var a, x, _fn, _i, _len, _ref;
              _ref = ((function() {
                var _j, _len, _ref, _results;
                _ref = document.getElementsByClassName("editArea");
                _results = [];
                for (_j = 0, _len = _ref.length; _j < _len; _j++) {
                  x = _ref[_j];
                  _results.push(x);
                }
                return _results;
              })()).reverse();
              _fn = function(a, e) {
                e = ace.require("ace/ext/textarea").transformTextarea(a);
                e.navigateFileEnd();
                a.setupTransform(e);
                a.onchange = function() {
                  e.setValue(this.value, -1);
                };
                e.on("change", function() {
                  a.value = e.getValue();
                  if (typeof a.oninput === "function") {
                    a.oninput();
                  }
                });
                e.on("blur", function() {
                  a.value = e.getValue();
                  if (typeof a.onblur === "function") {
                    a.onblur();
                  }
                });
                return e.on("focus", function() {
                  if (typeof a.onfocus === "function") {
                    a.onfocus();
                  }
                });
              };
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                a = _ref[_i];
                _fn(a, ace.require("ace/ext/textarea").transformTextarea(a));
              }
            });
          });
        });
      })();
</script></body></html>